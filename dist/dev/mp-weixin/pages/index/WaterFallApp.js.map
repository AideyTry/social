{"version":3,"file":"WaterFallApp.js","sources":["../../../../../src/pages/index/WaterFallApp.vue","../../../../../uniComponent:/QzovbXlzZWxmL3NvY2lhbC9zb2NpYWwvc3JjL3BhZ2VzL2luZGV4L1dhdGVyRmFsbEFwcC52dWU"],"sourcesContent":["<!--\r\n * @Author: Aiden(戴林波)\r\n * @Date: 2022-02-24 14:06:50\r\n * @LastEditTime: 2022-06-24 17:57:51\r\n * @LastEditors: Aiden(戴林波)\r\n * @Description: \r\n * @Email: jason_dlb@sina.cn\r\n-->\r\n<template>\r\n  <view class=\"waterfall\">\r\n    <view hidden>\r\n      <view v-for=\"item in props.list\" :key=\"item.id\">\r\n        <image\r\n          :src=\"item.url\"\r\n          @load=\"loadImg($event, item)\"\r\n          v-if=\"item.url\"\r\n        ></image>\r\n      </view>\r\n    </view>\r\n    <view class=\"list\" v-for=\"list in waterfall\" :key=\"list.height\">\r\n      <view v-for=\"item in list.list\" :key=\"item.id\" @click=\"goDetail(item)\">\r\n        <text>{{ item.title }}</text>\r\n        <view class=\"waterfall-image-wrapper\">\r\n          <image\r\n            class=\"waterfall-image\"\r\n            mode=\"widthFix\"\r\n            :style=\"{ width: waterfallImageWidth + 'rpx' }\"\r\n            :src=\"item.url\"\r\n          ></image>\r\n          <span v-if=\"item.fileType\" class=\"iconfont video-icon\">&#xe7c7;</span>\r\n        </view>\r\n        <view class=\"hobby-title\" ref=\"hobbyTitle\">{{ item.title }}</view>\r\n        <view class=\"hobby-info\">\r\n          <view class=\"info\">\r\n            <image class=\"avatar\" mode=\"aspectFit\" :src=\"item.avatar\"></image>\r\n            <text>{{ item.username }}</text>\r\n          </view>\r\n          <view>\r\n            <!-- <svg v-if=\"item.likeFlag\" class=\"icon\" aria-hidden=\"true\" @click.stop=\"like(item)\">\r\n            <use xlink:href=\"#icon-xihuan1\"></use>\r\n          </svg>\r\n          <svg v-else class=\"icon\" aria-hidden=\"true\" @click.stop=\"like(item)\">\r\n            <use xlink:href=\"#icon-xihuan\"></use>\r\n          </svg> -->\r\n            <span\r\n              v-if=\"item.likeFlag\"\r\n              style=\"color: #f00\"\r\n              class=\"iconfont\"\r\n              @click.stop=\"like(item)\"\r\n              >&#xe86f;</span\r\n            >\r\n            <span v-else class=\"iconfont\" @click.stop=\"like(item)\"\r\n              >&#xe86f;</span\r\n            >\r\n            <text style=\"margin-left: 10rpx\">{{ item.likes }}</text>\r\n          </view>\r\n        </view>\r\n      </view>\r\n    </view>\r\n  </view>\r\n</template>\r\n\r\n<script>\r\nexport default {\r\n  name: \"waterFall\",\r\n};\r\n</script>\r\n\r\n<script setup>\r\nimport {\r\n  ref,\r\n  reactive,\r\n  onMounted,\r\n  onUnmounted,\r\n  onUpdated,\r\n  onBeforeUnmount,\r\n  getCurrentInstance,\r\n  watchEffect,\r\n} from \"vue\";\r\n\r\nimport { getLike, setLike } from \"@/api/communication.js\";\r\n\r\nconst props = defineProps({\r\n  list: {\r\n    type: Array,\r\n    default: [],\r\n  },\r\n  activeIndex: {\r\n    type: Number,\r\n    default: 1,\r\n  },\r\n});\r\nlet waterfallList = ref([]); // 需要渲染的数据列表\r\n\r\nlet lists = ref(props.list);\r\nlet waterfall = reactive([\r\n  {\r\n    height: 0,\r\n    list: [],\r\n  },\r\n  {\r\n    height: 0,\r\n    list: [],\r\n  },\r\n]);\r\n\r\nlet waterfallImageWidth = ref(328); // 每一列宽度\r\n\r\nconst goDetail = (item) => {\r\n  console.log(\"item=\", item);\r\n  console.log(\"props===\", props);\r\n  console.log('item.id========', item.id)\r\n  console.log('props.activeIndex=====', props.activeIndex)\r\n  uni.navigateTo({\r\n    url: `/pages/index/HobbyDetailMountain?id=${item.id}&hobby=${props.activeIndex}`,\r\n  });\r\n};\r\n\r\nconst loadImg = (ev, item) => {\r\n  console.log(\"ev================\", ev);\r\n  console.log(\"item================,\", item);\r\n  let height = ev.detail.height * waterfallImageWidth.value / ev.detail.width;\r\n  console.log('height==================', height)\r\n  // 根据当前高度决定将新数据给谁，并更新列高度；优先插入左侧\r\n  if (waterfall[0].height <= waterfall[1].height) {\r\n    // 考虑热度优先的问题， 所以用的是shift()方法推出头部数据。\r\n    waterfall[0].list.push(lists.value.shift());\r\n    waterfall[0].height += height;\r\n  } else {\r\n    waterfall[1].list.push(lists.value.shift());\r\n    waterfall[1].height += height;\r\n  }\r\n};\r\n\r\n// 点赞\r\nconst like = (item) => {\r\n  console.log(\"item=\", item);\r\n  // item.likeFlag = true\r\n  let likeIds = uni.getStorageSync(\"like\") || [];\r\n  if (likeIds.includes(item.id)) {\r\n    console.log(\"isOK=\", likeIds);\r\n    for (let i = 0; i < likeIds.length; i++) {\r\n      if (likeIds[i] === item.id) {\r\n        likeIds.splice(i, 1);\r\n      }\r\n    }\r\n    item.likes -= 1;\r\n    item.likeFlag = false;\r\n    uni.setStorageSync(\"like\", likeIds);\r\n  } else {\r\n    item.likes += 1;\r\n    item.likeFlag = true;\r\n    console.log(\"likeIds=\", likeIds);\r\n    likeIds.unshift(item.id);\r\n    uni.setStorageSync(\"like\", likeIds);\r\n  }\r\n  const params = { hobby: props.activeIndex, hobbyId: item.id };\r\n  setLike(params).then((data) => {\r\n    console.log(\"like data=\", data);\r\n  });\r\n};\r\n\r\nconst getLikes = () => {\r\n  const params = {\r\n    hobby: props.activeIndex,\r\n  };\r\n  getLike(params).then((data) => {\r\n    console.log(\"getLike=\", data);\r\n    if (data.data.code === 200) {\r\n      const ids = data.data.likes.map((item) => item.hobby_id);\r\n      uni.setStorageSync(\"like\", ids);\r\n      for (let i = 0; i < waterfallList.value.length; i++) {\r\n        if (ids.includes(waterfallList.value[i].id)) {\r\n          waterfallList.value[i].likeFlag = true;\r\n        } else {\r\n          waterfallList.value[i].likeFlag = false;\r\n        }\r\n      }\r\n      console.log(\"waterfallList====\", waterfallList.value);\r\n    }\r\n  });\r\n};\r\n\r\nwatchEffect(() => {\r\n  lists.value = props.list;\r\n});\r\n\r\nonMounted(() => {\r\n  console.log(\"list1=\", props.list);\r\n  console.log(\"6666lists================\", lists);\r\n});\r\nonUpdated(() => {\r\n  console.log(\"list2=\", props.list);\r\n  console.log(\"6666lists================\", lists.value);\r\n  console.log(\"waterfall.value===\", waterfall);\r\n  // initWaterfall();\r\n});\r\nonBeforeUnmount(() => {\r\n    console.log('onBeforeUnmount==========================')\r\n})\r\nonUnmounted(() => {\r\n  console.log('===卸载啦。。。。。。。。。。。。。。。。。。。。。')\r\n  waterfall = reactive([\r\n    {\r\n      height: 0,\r\n      list: [],\r\n    },\r\n    {\r\n      height: 0,\r\n      list: [],\r\n    },\r\n  ]);\r\n});\r\n</script>\r\n\r\n<style lang=\"scss\" scoped>\r\n.waterfall {\r\n  width: 100%;\r\n  height: 100%;\r\n  position: relative;\r\n  display: flex;\r\n  justify-content: space-between;\r\n}\r\n.waterfall-item {\r\n  position: absolute;\r\n  float: left;\r\n}\r\n.waterfall-image-wrapper {\r\n  position: relative;\r\n  .waterfall-image {\r\n    position: absolue;\r\n  }\r\n  .video-icon {\r\n    position: absolute;\r\n    left: 50%;\r\n    top: 50%;\r\n    transform: translate(-50%, -50%);\r\n    width: 2em;\r\n    height: 2em;\r\n    vertical-align: -0.15em;\r\n    fill: currentColor;\r\n    overflow: hidden;\r\n    opacity: 0.6;\r\n  }\r\n}\r\n.hobby-title {\r\n  position: relative;\r\n  // bottom: 0;\r\n  padding: 20rpx;\r\n  overflow: hidden;\r\n  text-overflow: ellipsis;\r\n  display: block;\r\n  -webkit-line-clamp: 2;\r\n  -webkit-box-orient: vertical;\r\n  color: #363636;\r\n  background-color: #fff;\r\n}\r\n.hobby-info {\r\n  display: flex;\r\n  background-color: #fff;\r\n  padding: 0 20rpx 20rpx;\r\n  justify-content: space-between;\r\n  align-items: center;\r\n  font-size: 24rpx;\r\n  .info {\r\n    display: flex;\r\n    align-items: center;\r\n  }\r\n  .avatar {\r\n    width: 52rpx;\r\n    height: 52rpx;\r\n    border-radius: 50%;\r\n    background-color: #ccc;\r\n    margin-right: 20rpx;\r\n  }\r\n}\r\n</style>\r\n","import Component from 'C:/myself/social/social/src/pages/index/WaterFallApp.vue'\nwx.createComponent(Component)"],"names":["ref","reactive","uni","setLike","watchEffect","onMounted","onUpdated","onBeforeUnmount","onUnmounted"],"mappings":"8JA+DA,QAAe,CACb,KAAM,WACR,iHA2BoBA,MAAI,EAAE,EAE1B,GAAI,GAAQA,MAAI,EAAM,IAAI,EACtB,EAAYC,WAAS,CACvB,CACE,OAAQ,EACR,KAAM,IAER,CACE,OAAQ,EACR,KAAM,GAEV,CAAC,EAEG,EAAsBD,MAAI,GAAG,EAEjC,KAAM,GAAW,AAAC,GAAS,CACzB,QAAQ,IAAI,QAAS,CAAI,EACzB,QAAQ,IAAI,WAAY,CAAK,EAC7B,QAAQ,IAAI,kBAAmB,EAAK,EAAE,EACtC,QAAQ,IAAI,yBAA0B,EAAM,WAAW,EACvDE,QAAI,WAAW,CACb,IAAK,uCAAuC,EAAK,YAAY,EAAM,cACpE,CACH,EAEM,EAAU,CAAC,EAAI,IAAS,CAC5B,QAAQ,IAAI,qBAAsB,CAAE,EACpC,QAAQ,IAAI,wBAAyB,CAAI,EACzC,GAAI,GAAS,EAAG,OAAO,OAAS,EAAoB,MAAQ,EAAG,OAAO,MACtE,QAAQ,IAAI,2BAA4B,CAAM,EAE9C,AAAI,EAAU,GAAG,QAAU,EAAU,GAAG,OAEtC,GAAU,GAAG,KAAK,KAAK,EAAM,MAAM,OAAO,EAC1C,EAAU,GAAG,QAAU,GAEvB,GAAU,GAAG,KAAK,KAAK,EAAM,MAAM,OAAO,EAC1C,EAAU,GAAG,QAAU,EAE3B,EAGM,EAAO,AAAC,GAAS,CACrB,QAAQ,IAAI,QAAS,CAAI,EAEzB,GAAI,GAAUA,QAAI,eAAe,MAAM,GAAK,GAC5C,GAAI,EAAQ,SAAS,EAAK,EAAE,EAAG,CAC7B,QAAQ,IAAI,QAAS,CAAO,EAC5B,OAAS,GAAI,EAAG,EAAI,EAAQ,OAAQ,IAClC,AAAI,EAAQ,KAAO,EAAK,IACtB,EAAQ,OAAO,EAAG,CAAC,EAGvB,EAAK,OAAS,EACd,EAAK,SAAW,GAChBA,QAAI,eAAe,OAAQ,CAAO,MAElC,GAAK,OAAS,EACd,EAAK,SAAW,GAChB,QAAQ,IAAI,WAAY,CAAO,EAC/B,EAAQ,QAAQ,EAAK,EAAE,EACvBA,QAAI,eAAe,OAAQ,CAAO,EAEpC,KAAM,GAAS,CAAE,MAAO,EAAM,YAAa,QAAS,EAAK,IACzDC,UAAQ,CAAM,EAAE,KAAK,AAAC,GAAS,CAC7B,QAAQ,IAAI,aAAc,CAAI,EAC/B,CACH,EAuBAC,qBAAY,IAAM,CAChB,EAAM,MAAQ,EAAM,IACtB,CAAC,EAEDC,YAAU,IAAM,CACd,QAAQ,IAAI,SAAU,EAAM,IAAI,EAChC,QAAQ,IAAI,4BAA6B,CAAK,CAChD,CAAC,EACDC,YAAU,IAAM,CACd,QAAQ,IAAI,SAAU,EAAM,IAAI,EAChC,QAAQ,IAAI,4BAA6B,EAAM,KAAK,EACpD,QAAQ,IAAI,qBAAsB,CAAS,CAE7C,CAAC,EACDC,kBAAgB,IAAM,CAClB,QAAQ,IAAI,2CAA2C,CAC3D,CAAC,EACDC,cAAY,IAAM,CAChB,QAAQ,IAAI,qJAA6B,EACzC,EAAYP,WAAS,CACnB,CACE,OAAQ,EACR,KAAM,IAER,CACE,OAAQ,EACR,KAAM,IAET,CACH,CAAC,8gBCnND,GAAG,gBAAgB,CAAS"}