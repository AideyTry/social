{"version":3,"file":"Chat.js","sources":["../../../../../src/pages/message/Chat.vue","../../../../../uniPage:/cGFnZXMvbWVzc2FnZS9DaGF0LnZ1ZQ"],"sourcesContent":["<template>\r\n  <view class=\"chat-wraper\">\r\n    <ChatContent :key=\"currentDate\" :msgList=\"messageInfo\"></ChatContent>\r\n    <view class=\"send-msg\">\r\n      <input\r\n        type=\"text\"\r\n        placeholder=\"请输入消息\"\r\n        v-model=\"inputString\"\r\n        class=\"send\"\r\n        @confirm=\"onConfirm\"\r\n      />\r\n    </view>\r\n  </view>\r\n</template>\r\n\r\n<script>\r\nimport { onMounted, computed, ref, watch, onUpdated, onBeforeUpdate } from \"vue\";\r\nimport openIM from \"@/utils/openIM.js\";\r\nimport { getIMToken } from \"../../utils/auth.js\";\r\nimport { useStore } from \"vuex\";\r\nimport ChatContent from \"./ChatContent.vue\";\r\nimport { connectIM } from '@/utils/im.js'\r\nexport default {\r\n  components: {\r\n    ChatContent,\r\n  },\r\n  onShow: function (showprops) {\r\n    this.currentDate = new Date() + Math.random()\r\n    setTimeout(() => {\r\n      this.getConver()\r\n    }, 1000)\r\n  },\r\n  onLoad: function(options) {\r\n    this.propsOptions = options\r\n  },\r\n  setup(props) {\r\n    let propsOptions = ref(null)\r\n    let inputString = ref(\"\");\r\n    const messageInfo = ref([]);\r\n\r\n    const store = useStore();\r\n\r\n    console.log('store.state.user===========================================================================', store.getters['user/getUserInfo'])\r\n    const userInfo = computed(() => store.getters['user/getUserInfo']).value;\r\n\r\n    const monitorOnRecv = () => {\r\n      openIM.on(\"OnRecvNewMessage\", (data) => {\r\n        const RecvMessage = JSON.parse(data.data);\r\n        if (RecvMessage.contentType === 101) {\r\n          messageInfo.value.unshift(RecvMessage);\r\n        }\r\n      });\r\n    };\r\n\r\n    const getConver = () => {\r\n      // connectIM(userInfo.phone, getIMToken())\r\n      const options = {\r\n        groupID: \"\", // 群聊ID，拉取群聊时传入，否则为“”\r\n        startClientMsgID: \"\", // 上一次拉取的最后一条消息ID或空字符串,为空字符则从最新一条开始\r\n        count: 10000, // 每次拉取条数\r\n        // userID: props.userID, // 用户ID，拉取单聊时传入，否则为“”\r\n        userID: propsOptions.value.userID, // 用户ID，拉取单聊时传入，否则为“”\r\n      };\r\n      openIM\r\n        .getHistoryMessageList(options)\r\n        .then(({ data }) => {\r\n          console.log(\"历史数据=\", JSON.parse(data));\r\n          messageInfo.value = [...JSON.parse(data).reverse()];\r\n        })\r\n        .catch((err) => {\r\n          console.log('err 000000000000000000000000000000000000000000=', err)\r\n        });\r\n    };\r\n    const onConfirm = (event) => {\r\n      const { value } = event.detail;\r\n      inputString.value = value;\r\n      const offlinePushInfo = {\r\n        title: \"you have a new message\", // 推送标题\r\n        desc: \"\", // 推送描述\r\n        ex: \"\", // 扩展字段\r\n        iOSPushSound: \"\", // ios推送声音\r\n        iOSBadgeCount: false, // ios推送角标\r\n      };\r\n      openIM\r\n        .createTextMessage(value)\r\n        .then((res) => {\r\n          const options = {\r\n            // recvID: props.userID,\r\n            recvID: propsOptions.value.userID,\r\n            groupID: \"\",\r\n            offlinePushInfo: offlinePushInfo,\r\n            message: res.data,\r\n          };\r\n          openIM\r\n            .sendMessage(options)\r\n            .then(({ data, errCode }) => {\r\n              const SendMessage = JSON.parse(data);\r\n              messageInfo.value.unshift(SendMessage);\r\n              inputString.value = \"\";\r\n            })\r\n            .catch((err) => {\r\n              console.log(\"err=\", err);\r\n            });\r\n        })\r\n        .catch((err) => {\r\n          console.log(\"text err=\", err);\r\n        });\r\n    };\r\n\r\n    /**\r\n     * @description: 已读监听\r\n     * @param {*}\r\n     * @Author: \r\n     * @return {*}\r\n     */    \r\n    const asRead = () => {\r\n      openIM.on(\"OnRecvC2CReadReceipt\", (data) => {\r\n        JSON.parse(data.data).map(cr => {\r\n          cr.msgIDList.map(crt => {\r\n            messageInfo.value.find(ms => {\r\n              if(ms.clientMsgID === crt){\r\n                ms.isRead = true\r\n              }\r\n            })\r\n          })\r\n        })\r\n      });\r\n    };\r\n\r\n    watch(\r\n      () => messageInfo,\r\n      (count, prevCount) => {\r\n        const selfMessages = count.value.filter(\r\n          (item) => item.sendID === propsOptions.value.userID\r\n        );\r\n        const msgIDList = selfMessages.map((element) => element.clientMsgID);\r\n        const options = {\r\n          // userID: props.userID,\r\n          userID: propsOptions.value.userID,\r\n          msgIDList,\r\n        };\r\n        openIM\r\n          .markC2CMessageAsRead(options)\r\n          .then(({ data }) => {\r\n            console.log(\"传入已读=\", data);\r\n            openIM.markC2CMessageAsRead({\r\n              // userID: props.userID,\r\n              userID: propsOptions.value.userID,\r\n              msgIDList: [],\r\n            });\r\n          })\r\n          .catch((err) => {\r\n            console.log(\"err===\", err);\r\n          });\r\n      },\r\n      {\r\n        deep: true,\r\n      }\r\n    );\r\n    onMounted(() => {\r\n      uni.setNavigationBarTitle({\r\n        // title: props.title,\r\n        title: propsOptions.value.title,\r\n      });\r\n      getConver();\r\n      monitorOnRecv();\r\n      asRead()\r\n    });\r\n    let currentDate = ref('')\r\n    return {\r\n      inputString,\r\n      messageInfo,\r\n      onConfirm,\r\n      currentDate,\r\n      getConver,\r\n      propsOptions\r\n    };\r\n  },\r\n};\r\n</script>\r\n\r\n<style lang=\"scss\" scoped>\r\n.chat-wraper {\r\n  .send-msg {\r\n    position: fixed;\r\n    bottom: 0;\r\n    display: flex;\r\n    justify-content: center;\r\n    align-items: center;\r\n    padding: 20rpx 0;\r\n    width: 100%;\r\n    background-color: #eaeaea;\r\n    .send {\r\n      background-color: #fff;\r\n      height: 80rpx;\r\n      width: 460rpx;\r\n    }\r\n  }\r\n}\r\n</style>\r\n","import MiniProgramPage from 'C:/myself/social/social/src/pages/message/Chat.vue'\nwx.createPage(MiniProgramPage)"],"names":["ref","useStore","computed","openIM","watch","onMounted","uni"],"mappings":"wFAoBA,QAAoB,IAAW,sBAG7B,WAAY,CACV,eAEF,OAAQ,SAAU,EAAW,CAC3B,KAAK,YAAc,GAAI,MAAS,KAAK,SACrC,WAAW,IAAM,CACf,KAAK,aACJ,GAAI,GAET,OAAQ,SAAS,EAAS,CACxB,KAAK,aAAe,GAEtB,MAAM,EAAO,CACX,GAAI,GAAeA,MAAI,IAAI,EACvB,EAAcA,MAAI,EAAE,EACxB,KAAM,GAAcA,MAAI,EAAE,EAEpB,EAAQC,aAEd,QAAQ,IAAI,8FAA+F,EAAM,QAAQ,mBAAmB,EAC3HC,aAAS,IAAM,EAAM,QAAQ,mBAAmB,EAAE,MAEnE,KAAM,GAAgB,IAAM,CAC1BC,SAAO,GAAG,mBAAoB,AAAC,GAAS,CACtC,KAAM,GAAc,KAAK,MAAM,EAAK,IAAI,EACxC,AAAI,EAAY,cAAgB,KAC9B,EAAY,MAAM,QAAQ,CAAW,EAExC,GAGG,EAAY,IAAM,CAEtB,KAAM,GAAU,CACd,QAAS,GACT,iBAAkB,GAClB,MAAO,IAEP,OAAQ,EAAa,MAAM,QAE7BA,SACG,sBAAsB,CAAO,EAC7B,KAAK,CAAC,CAAE,UAAW,CAClB,QAAQ,IAAI,4BAAS,KAAK,MAAM,CAAI,CAAC,EACrC,EAAY,MAAQ,CAAC,GAAG,KAAK,MAAM,CAAI,EAAE,SAAS,EACnD,EACA,MAAM,AAAC,GAAQ,CACd,QAAQ,IAAI,kDAAmD,CAAG,EACnE,GAEC,EAAY,AAAC,GAAU,CAC3B,KAAM,CAAE,SAAU,EAAM,OACxB,EAAY,MAAQ,EACpB,KAAM,GAAkB,CACtB,MAAO,yBACP,KAAM,GACN,GAAI,GACJ,aAAc,GACd,cAAe,IAEjBA,SACG,kBAAkB,CAAK,EACvB,KAAK,AAAC,GAAQ,CACb,KAAM,GAAU,CAEd,OAAQ,EAAa,MAAM,OAC3B,QAAS,GACT,gBAAiB,EACjB,QAAS,EAAI,MAEfA,SACG,YAAY,CAAO,EACnB,KAAK,CAAC,CAAE,OAAM,aAAc,CAC3B,KAAM,GAAc,KAAK,MAAM,CAAI,EACnC,EAAY,MAAM,QAAQ,CAAW,EACrC,EAAY,MAAQ,GACrB,EACA,MAAM,AAAC,GAAQ,CACd,QAAQ,IAAI,OAAQ,CAAG,EACxB,EACJ,EACA,MAAM,AAAC,GAAQ,CACd,QAAQ,IAAI,YAAa,CAAG,EAC7B,GASC,EAAS,IAAM,CACnBA,SAAO,GAAG,uBAAwB,AAAC,GAAS,CAC1C,KAAK,MAAM,EAAK,IAAI,EAAE,IAAI,GAAM,CAC9B,EAAG,UAAU,IAAI,GAAO,CACtB,EAAY,MAAM,KAAK,GAAM,CAC3B,AAAG,EAAG,cAAgB,GACpB,GAAG,OAAS,IAEf,EACF,EACF,EACF,GAGHC,QACE,IAAM,EACN,CAAC,EAAO,IAAc,CAIpB,KAAM,GAAY,AAHG,EAAM,MAAM,OAC/B,AAAC,GAAS,EAAK,SAAW,EAAa,MAAM,QAEhB,IAAI,AAAC,GAAY,EAAQ,WAAW,EAC7D,EAAU,CAEd,OAAQ,EAAa,MAAM,OAC3B,aAEFD,SACG,qBAAqB,CAAO,EAC5B,KAAK,CAAC,CAAE,UAAW,CAClB,QAAQ,IAAI,4BAAS,CAAI,EACzBA,SAAO,qBAAqB,CAE1B,OAAQ,EAAa,MAAM,OAC3B,UAAW,GACZ,EACF,EACA,MAAM,AAAC,GAAQ,CACd,QAAQ,IAAI,SAAU,CAAG,EAC1B,GAEL,CACE,KAAM,KAGVE,YAAU,IAAM,CACdC,QAAI,sBAAsB,CAExB,MAAO,EAAa,MAAM,MAC3B,EACD,IACA,IACA,IACD,EACD,GAAI,GAAcN,MAAI,EAAE,EACxB,MAAO,CACL,cACA,cACA,YACA,cACA,YACA,gBAGN,2WCjLA,GAAG,WAAW,CAAe"}