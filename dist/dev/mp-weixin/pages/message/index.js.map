{"version":3,"file":"index.js","sources":["../../../../../src/pages/message/index.vue","../../../../../uniPage:/cGFnZXMvbWVzc2FnZS9pbmRleC52dWU"],"sourcesContent":["<!--\r\n * @Author: Aiden(戴林波)\r\n * @Date: 2021-12-17 17:50:38\r\n * @LastEditTime: 2022-07-05 14:15:10\r\n * @LastEditors: Aiden(戴林波)\r\n * @Description: \r\n * @Email: jason_dlb@sina.cn\r\n-->\r\n<template>\r\n  <view class=\"message-wrapper\">\r\n    <view\r\n      v-for=\"item in convers\"\r\n      :key=\"item.userID\"\r\n      class=\"conver\"\r\n      @click=\"goChat(item)\"\r\n    >\r\n      <view class=\"conver-msg\">\r\n        <view class=\"chat_bg_msg_icon-wraper\">\r\n          <image\r\n            :src=\"\r\n              item.faceURL && item.faceURL.includes('https://')\r\n                ? item.faceURL\r\n                : defaultAvatar\r\n            \"\r\n            class=\"chat_bg_msg_icon\"\r\n          />\r\n          <view class=\"unread-total\" v-if=\"item.unreadCount\"\r\n            ><text>{{ item.unreadCount }}</text></view\r\n          >\r\n        </view>\r\n        <view class=\"content-wraper\">\r\n          <text>{{ item.showName }}</text>\r\n          <text>{{ showLastMessage(item.latestMsg) }}</text>\r\n        </view>\r\n      </view>\r\n      <text class=\"conver-time\">{{\r\n        $filters.formatMsgDate(item.latestMsgSendTime)\r\n      }}</text>\r\n    </view>\r\n    <view v-if=\"convers.length <= 0\" class=\"empty\">\r\n      <view>您还未发起聊天</view>\r\n      <view>快去关注兴趣爱好发布者一起聊天吧~！</view>\r\n    </view>\r\n  </view>\r\n</template>\r\n\r\n<script>\r\nimport { onMounted, computed, ref, watch } from \"vue\";\r\nimport openIM from \"@/utils/openIM.js\";\r\nimport { getIMToken } from \"../../utils/auth.js\";\r\nimport { useStore } from \"vuex\";\r\nimport ChatContent from \"./ChatContent.vue\";\r\nexport default {\r\n  components: {\r\n    ChatContent,\r\n  },\r\n  onShow(){\r\n    console.log('show======')\r\n    this.getAllConversationList()\r\n  },\r\n  setup() {\r\n    const defaultAvatar = \"/static/images/default_avatar.png\";\r\n    const store = useStore();\r\n    const userInfo = computed(() => store.state.user.userInfo).value;\r\n    const convers = ref([]);\r\n    const goChat = (item) => {\r\n      console.log(\"item=\", item);\r\n      uni.navigateTo({\r\n        url: `/pages/message/Chat?userID=${item.userID}&title=${item.showName}`,\r\n      });\r\n    };\r\n    const getAllConversationList = () => {\r\n      openIM\r\n        .getAllConversationList()\r\n        .then(({ data }) => {\r\n          console.log(\"会话总数data====\", JSON.parse(data));\r\n          convers.value = JSON.parse(data);\r\n          unReadMessage();\r\n        })\r\n        .catch((err) => {\r\n          console.log(\"err=\", err);\r\n        });\r\n    };\r\n    const connectIM = (userID, token) => {\r\n      console.log(\"userID, token=====================\", userID, token);\r\n      const config = {\r\n        userID,\r\n        token,\r\n        // url: \"ws://42.192.229.151/:10003\",\r\n        url: \"wss://mancao.social:20038\",\r\n        platformID: 5,\r\n      };\r\n      openIM\r\n        .login(config)\r\n        .then((res) => {\r\n          console.log(\"login suc...\", res);\r\n          if (res.errCode === 0) {\r\n            getAllConversationList();\r\n          }\r\n        })\r\n        .catch((err) => {\r\n          console.log(\"login failed...\", err);\r\n        });\r\n    };\r\n\r\n    const showLastMessage = (lastData) => {\r\n      return JSON.parse(lastData).content;\r\n    };\r\n\r\n    const unReadMessage = () => {\r\n      openIM\r\n        .getTotalUnreadMsgCount()\r\n        .then(({ data }) => {\r\n          console.log(\"data===\", data);\r\n          console.log('Number(data)=', Number(data))\r\n          if(Number(data) > 0){\r\n          uni.setTabBarBadge({\r\n            index: 2,\r\n            text: '···'\r\n          });\r\n          }else {\r\n            uni.removeTabBarBadge({\r\n              index: 2\r\n            })\r\n          }\r\n        })\r\n        .catch((err) => {\r\n          console.log(\"err=\", err);\r\n        });\r\n    };\r\n\r\n    const monitorOnRecv = () => {\r\n      openIM.on(\"OnRecvNewMessage\", (data) => {\r\n        const RecvMessage = JSON.parse(data.data);\r\n        if (RecvMessage.contentType === 101) {\r\n          getAllConversationList();\r\n        }\r\n      });\r\n    };\r\n\r\n    onMounted(() => {\r\n      connectIM(userInfo.phone, getIMToken());\r\n      monitorOnRecv();\r\n      // login();\r\n      // resiger()\r\n    });\r\n    return {\r\n      defaultAvatar,\r\n      convers,\r\n      goChat,\r\n      showLastMessage,\r\n      getAllConversationList\r\n    };\r\n  },\r\n};\r\n</script>\r\n\r\n<style scoped lang=\"scss\">\r\n.empty{\r\n  padding-top: 48rpx;\r\n  display: flex;\r\n  flex-direction: column;\r\n  justify-content: center;\r\n  align-items: center;\r\n  color: #a0a0a0;\r\n}\r\n.conver {\r\n  display: flex;\r\n  justify-content: space-between;\r\n  border-bottom: 1rpx solid #dbdbdb;\r\n  padding: 10rpx;\r\n  .conver-msg {\r\n    display: flex;\r\n  }\r\n  .chat_bg_msg_icon-wraper {\r\n    position: relative;\r\n  }\r\n  .unread-total {\r\n    position: absolute;\r\n    right: -12rpx;\r\n    top: -8rpx;\r\n    width: auto;\r\n    height: auto;\r\n    border-radius: 50%;\r\n    padding: 4rpx;\r\n    background: #f00;\r\n    color: #fff;\r\n    font-size: 12rpx;\r\n    display: flex;\r\n    justify-content: center;\r\n    align-items: center;\r\n  }\r\n  .chat_bg_msg_icon {\r\n    width: 84rpx;\r\n    height: 84rpx;\r\n  }\r\n  .content-wraper {\r\n    display: flex;\r\n    flex-direction: column;\r\n    margin: 0 12rpx;\r\n    background-color: #f2f2f2;\r\n  }\r\n  .conver-time {\r\n  }\r\n}\r\n</style>\r\n","import MiniProgramPage from 'C:/myself/social/social/src/pages/message/index.vue'\nwx.createPage(MiniProgramPage)"],"names":["useStore","computed","ref","uni","openIM","onMounted","getIMToken"],"mappings":"yHAmDA,QAAoB,IAAW,sBAE7B,WAAY,CACV,eAEF,QAAQ,CACN,QAAQ,IAAI,YAAY,EACxB,KAAK,0BAEP,OAAQ,CACN,KAAM,GAAgB,oCAChB,EAAQA,aACR,EAAWC,aAAS,IAAM,EAAM,MAAM,KAAK,QAAQ,EAAE,MACrD,EAAUC,MAAI,EAAE,EAChB,EAAS,AAAC,GAAS,CACvB,QAAQ,IAAI,QAAS,CAAI,EACzBC,QAAI,WAAW,CACb,IAAK,8BAA8B,EAAK,gBAAgB,EAAK,WAC9D,GAEG,EAAyB,IAAM,CACnCC,SACG,yBACA,KAAK,CAAC,CAAE,UAAW,CAClB,QAAQ,IAAI,mCAAgB,KAAK,MAAM,CAAI,CAAC,EAC5C,EAAQ,MAAQ,KAAK,MAAM,CAAI,EAC/B,IACD,EACA,MAAM,AAAC,GAAQ,CACd,QAAQ,IAAI,OAAQ,CAAG,EACxB,GAEC,EAAY,CAAC,EAAQ,IAAU,CACnC,QAAQ,IAAI,qCAAsC,EAAQ,CAAK,EAC/D,KAAM,GAAS,CACb,SACA,QAEA,IAAK,4BACL,WAAY,GAEdA,SACG,MAAM,CAAM,EACZ,KAAK,AAAC,GAAQ,CACb,QAAQ,IAAI,eAAgB,CAAG,EAC3B,EAAI,UAAY,GAClB,IAEH,EACA,MAAM,AAAC,GAAQ,CACd,QAAQ,IAAI,kBAAmB,CAAG,EACnC,GAGC,EAAkB,AAAC,GAChB,KAAK,MAAM,CAAQ,EAAE,QAGxB,EAAgB,IAAM,CAC1BA,SACG,yBACA,KAAK,CAAC,CAAE,UAAW,CAClB,QAAQ,IAAI,UAAW,CAAI,EAC3B,QAAQ,IAAI,gBAAiB,OAAO,CAAI,CAAC,EACzC,AAAG,OAAO,CAAI,EAAI,EAClBD,QAAI,eAAe,CACjB,MAAO,EACP,KAAM,eACP,EAECA,QAAI,kBAAkB,CACpB,MAAO,EACR,EAEJ,EACA,MAAM,AAAC,GAAQ,CACd,QAAQ,IAAI,OAAQ,CAAG,EACxB,GAGC,EAAgB,IAAM,CAC1BC,SAAO,GAAG,mBAAoB,AAAC,GAAS,CAEtC,AAAI,AADgB,KAAK,MAAM,EAAK,IAAI,EACxB,cAAgB,KAC9B,IAEH,GAGHC,mBAAU,IAAM,CACd,EAAU,EAAS,MAAOC,cAAY,EACtC,IAGD,EACM,CACL,gBACA,UACA,SACA,kBACA,0BAGN,yhBCzJA,GAAG,WAAW,CAAe"}