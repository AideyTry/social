"use strict";var p={email:/^\S+?@\S+?\.\S+?$/,idcard:/^[1-9]\d{5}(18|19|([23]\d))\d{2}((0[1-9])|(10|11|12))(([0-2][1-9])|10|20|30|31)\d{3}[0-9Xx]$/,url:new RegExp("^(?!mailto:)(?:(?:http|https|ftp)://|//)(?:\\S+(?::\\S*)?@)?(?:(?:(?:[1-9]\\d?|1\\d\\d|2[01]\\d|22[0-3])(?:\\.(?:1?\\d{1,2}|2[0-4]\\d|25[0-5])){2}(?:\\.(?:[0-9]\\d?|1\\d\\d|2[0-4]\\d|25[0-4]))|(?:(?:[a-z\\u00a1-\\uffff0-9]+-*)*[a-z\\u00a1-\\uffff0-9]+)(?:\\.(?:[a-z\\u00a1-\\uffff0-9]+-*)*[a-z\\u00a1-\\uffff0-9]+)*(?:\\.(?:[a-z\\u00a1-\\uffff]{2,})))|localhost)(?::\\d{2,5})?(?:(/|\\?|#)[^\\s]*)?$","i")};const y={int:"integer",bool:"boolean",double:"number",long:"number",password:"string"};function f(e,t=""){var n=["label"];n.forEach(i=>{e[i]===void 0&&(e[i]="")});let r=t;for(let i in e){let a=new RegExp("{"+i+"}");r=r.replace(a,e[i])}return r}function M(e,t){return!!(e==null||typeof e=="string"&&!e||Array.isArray(e)&&!e.length||t==="object"&&!Object.keys(e).length)}const o={integer(e){return o.number(e)&&parseInt(e,10)===e},string(e){return typeof e=="string"},number(e){return isNaN(e)?!1:typeof e=="number"},boolean:function(e){return typeof e=="boolean"},float:function(e){return o.number(e)&&!o.integer(e)},array(e){return Array.isArray(e)},object(e){return typeof e=="object"&&!o.array(e)},date(e){return e instanceof Date},timestamp(e){return!(!this.integer(e)||Math.abs(e).toString().length>16)},file(e){return typeof e.url=="string"},email(e){return typeof e=="string"&&!!e.match(p.email)&&e.length<255},url(e){return typeof e=="string"&&!!e.match(p.url)},pattern(e,t){try{return new RegExp(e).test(t)}catch{return!1}},method(e){return typeof e=="function"},idcard(e){return typeof e=="string"&&!!e.match(p.idcard)},"url-https"(e){return this.url(e)&&e.startsWith("https://")},"url-scheme"(e){return e.startsWith("://")},"url-web"(e){return!1}};class k{constructor(t){this._message=t}async validateRule(t,n,r,i,a){var s=null;let l=n.rules;if(l.findIndex(m=>m.required)<0&&(r==null||typeof r=="string"&&!r.length))return s;var g=this._message;if(l===void 0)return g.default;for(var h=0;h<l.length;h++){let m=l[h],c=this._getValidateType(m);if(Object.assign(m,{label:n.label||`["${t}"]`}),b[c]&&(s=b[c](m,r,g),s!=null))break;if(m.validateExpr){let x=Date.now();if(m.validateExpr(r,a,x)===!1){s=this._getMessage(m,m.errorMessage||this._message.default);break}}if(m.validateFunction&&(s=await this.validateFunction(m,r,i,a,c),s!==null))break}return s!==null&&(s=g.TAG+s),s}async validateFunction(t,n,r,i,a){let s=null;try{let l=null;const u=await t.validateFunction(t,n,i||r,g=>{l=g});(l||typeof u=="string"&&u||u===!1)&&(s=this._getMessage(t,l||u,a))}catch(l){s=this._getMessage(t,l.message,a)}return s}_getMessage(t,n,r){return f(t,n||t.errorMessage||this._message[r]||n.default)}_getValidateType(t){var n="";return t.required?n="required":t.format?n="format":t.arrayType?n="arrayTypeFormat":t.range?n="range":t.maximum!==void 0||t.minimum!==void 0?n="rangeNumber":t.maxLength!==void 0||t.minLength!==void 0?n="rangeLength":t.pattern?n="pattern":t.validateFunction&&(n="validateFunction"),n}}const b={required(e,t,n){return e.required&&M(t,e.format||typeof t)?f(e,e.errorMessage||n.required):null},range(e,t,n){const{range:r,errorMessage:i}=e;let a=new Array(r.length);for(let l=0;l<r.length;l++){const u=r[l];o.object(u)&&u.value!==void 0?a[l]=u.value:a[l]=u}let s=!1;return Array.isArray(t)?s=new Set(t.concat(a)).size===a.length:a.indexOf(t)>-1&&(s=!0),s?null:f(e,i||n.enum)},rangeNumber(e,t,n){if(!o.number(t))return f(e,e.errorMessage||n.pattern.mismatch);let{minimum:r,maximum:i,exclusiveMinimum:a,exclusiveMaximum:s}=e,l=a?t<=r:t<r,u=s?t>=i:t>i;return r!==void 0&&l?f(e,e.errorMessage||n.number[a?"exclusiveMinimum":"minimum"]):i!==void 0&&u?f(e,e.errorMessage||n.number[s?"exclusiveMaximum":"maximum"]):r!==void 0&&i!==void 0&&(l||u)?f(e,e.errorMessage||n.number.range):null},rangeLength(e,t,n){if(!o.string(t)&&!o.array(t))return f(e,e.errorMessage||n.pattern.mismatch);let r=e.minLength,i=e.maxLength,a=t.length;return r!==void 0&&a<r?f(e,e.errorMessage||n.length.minLength):i!==void 0&&a>i?f(e,e.errorMessage||n.length.maxLength):r!==void 0&&i!==void 0&&(a<r||a>i)?f(e,e.errorMessage||n.length.range):null},pattern(e,t,n){return o.pattern(e.pattern,t)?null:f(e,e.errorMessage||n.pattern.mismatch)},format(e,t,n){var r=Object.keys(o),i=y[e.format]?y[e.format]:e.format||e.arrayType;return r.indexOf(i)>-1&&!o[i](t)?f(e,e.errorMessage||n.typeError):null},arrayTypeFormat(e,t,n){if(!Array.isArray(t))return f(e,e.errorMessage||n.typeError);for(let r=0;r<t.length;r++){const i=t[r];let a=this.format(e,i,n);if(a!==null)return a}return null}};class d extends k{constructor(t,n){super(d.message),this._schema=t,this._options=n||null}updateSchema(t){this._schema=t}async validate(t,n){let r=this._checkFieldInSchema(t);return r||(r=await this.invokeValidate(t,!1,n)),r.length?r[0]:null}async validateAll(t,n){let r=this._checkFieldInSchema(t);return r||(r=await this.invokeValidate(t,!0,n)),r}async validateUpdate(t,n){let r=this._checkFieldInSchema(t);return r||(r=await this.invokeValidateUpdate(t,!1,n)),r.length?r[0]:null}async invokeValidate(t,n,r){let i=[],a=this._schema;for(let s in a){let l=a[s],u=await this.validateRule(s,l,t[s],t,r);if(u!=null&&(i.push({key:s,errorMessage:u}),!n))break}return i}async invokeValidateUpdate(t,n,r){let i=[];for(let a in t){let s=await this.validateRule(a,this._schema[a],t[a],t,r);if(s!=null&&(i.push({key:a,errorMessage:s}),!n))break}return i}_checkFieldInSchema(t){var n=Object.keys(t),r=Object.keys(this._schema);if(new Set(n.concat(r)).size===r.length)return"";var i=n.filter(s=>r.indexOf(s)<0),a=f({field:JSON.stringify(i)},d.message.TAG+d.message.defaultInvalid);return[{key:"invalid",errorMessage:a}]}}function w(){return{TAG:"",default:"\u9A8C\u8BC1\u9519\u8BEF",defaultInvalid:"\u63D0\u4EA4\u7684\u5B57\u6BB5{field}\u5728\u6570\u636E\u5E93\u4E2D\u5E76\u4E0D\u5B58\u5728",validateFunction:"\u9A8C\u8BC1\u65E0\u6548",required:"{label}\u5FC5\u586B",enum:"{label}\u8D85\u51FA\u8303\u56F4",timestamp:"{label}\u683C\u5F0F\u65E0\u6548",whitespace:"{label}\u4E0D\u80FD\u4E3A\u7A7A",typeError:"{label}\u7C7B\u578B\u65E0\u6548",date:{format:"{label}\u65E5\u671F{value}\u683C\u5F0F\u65E0\u6548",parse:"{label}\u65E5\u671F\u65E0\u6CD5\u89E3\u6790,{value}\u65E0\u6548",invalid:"{label}\u65E5\u671F{value}\u65E0\u6548"},length:{minLength:"{label}\u957F\u5EA6\u4E0D\u80FD\u5C11\u4E8E{minLength}",maxLength:"{label}\u957F\u5EA6\u4E0D\u80FD\u8D85\u8FC7{maxLength}",range:"{label}\u5FC5\u987B\u4ECB\u4E8E{minLength}\u548C{maxLength}\u4E4B\u95F4"},number:{minimum:"{label}\u4E0D\u80FD\u5C0F\u4E8E{minimum}",maximum:"{label}\u4E0D\u80FD\u5927\u4E8E{maximum}",exclusiveMinimum:"{label}\u4E0D\u80FD\u5C0F\u4E8E\u7B49\u4E8E{minimum}",exclusiveMaximum:"{label}\u4E0D\u80FD\u5927\u4E8E\u7B49\u4E8E{maximum}",range:"{label}\u5FC5\u987B\u4ECB\u4E8E{minimum}and{maximum}\u4E4B\u95F4"},pattern:{mismatch:"{label}\u683C\u5F0F\u4E0D\u5339\u914D"}}}d.message=new w;exports.SchemaValidator=d;
//# sourceMappingURL=validate.js.map
