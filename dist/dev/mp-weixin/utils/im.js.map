{"version":3,"file":"im.js","sources":["../../../../src/utils/im.js"],"sourcesContent":["/*\r\n * @Author: Aiden(戴林波)\r\n * @Date: 2022-05-11 22:49:17\r\n * @LastEditTime: 2022-05-15 14:26:02\r\n * @LastEditors: Aiden(戴林波)\r\n * @Description: \r\n * @Email: jason_dlb@sina.cn\r\n */\r\nimport {\r\n  imRegister,\r\n  imLogin\r\n} from \"@/api/im.js\";\r\nimport {\r\n  setIMToken\r\n} from \"@/utils/auth.js\";\r\nimport {\r\n  setTotalIM\r\n} from \"@/utils/storage.js\";\r\nimport openIM from \"@/utils/openIM.js\";\r\n\r\n\r\nconst unReadMessage = () => {\r\n  openIM\r\n    .getTotalUnreadMsgCount()\r\n    .then(({\r\n      data\r\n    }) => {\r\n      console.log(\"data==================================================================================\", data);\r\n      console.log('Number(data)=', Number(data))\r\n      // uni.$emit('updateIMMsgCount',{total: Number(data)})\r\n      setTotalIM(Number(data))\r\n    })\r\n    .catch((err) => {\r\n      console.log(\"err=\", err);\r\n    });\r\n};\r\n\r\nconst monitorOnRecv = () => {\r\n  openIM.on(\"OnRecvNewMessage\", (data) => {\r\n    const RecvMessage = JSON.parse(data.data);\r\n    if (RecvMessage.contentType === 101) {\r\n      unReadMessage()\r\n    }\r\n  });\r\n};\r\n\r\nexport const connectIM = (userID, token) => {\r\n  console.log(\"userID, token=====================\", userID, token);\r\n  const config = {\r\n    userID,\r\n    token,\r\n    // url: \"ws://42.192.229.151/:10003\",\r\n    url: \"wss://mancao.social:20038\",\r\n    platformID: 5,\r\n  };\r\n  openIM\r\n    .login(config)\r\n    .then((res) => {\r\n      console.log(\"login suc...\", res);\r\n      if (res.errCode === 0) {\r\n        unReadMessage()\r\n        monitorOnRecv()\r\n      }\r\n    })\r\n    .catch((err) => {\r\n      console.log(\"login failed...\", err);\r\n    });\r\n}\r\n\r\nexport const register = () => {\r\n  const params = {\r\n    secret: \"tuoyun\",\r\n    platform: 5,\r\n    operationID: Date.now() + \"\",\r\n  };\r\n  imRegister(params).then((res) => {\r\n    console.log(\"res========\", res);\r\n    if (res.statusCode === 200) {\r\n      console.log('res.data.data.token====', res.data.data.token)\r\n      setIMToken(res.data.data.token);\r\n      // connectIM(res.data.data.userID, res.data.data.token);\r\n    }\r\n  });\r\n};\r\nexport const login = () => {\r\n  const params = {\r\n    secret: \"tuoyun\",\r\n    platform: 5,\r\n    operationID: Date.now() + \"\",\r\n  };\r\n  imLogin(params).then((res) => {\r\n    console.log(\"res========\", res);\r\n    if (res.statusCode === 200) {\r\n      if (res.data.errCode !== 0) {\r\n        register();\r\n        return;\r\n      }\r\n      if (res.data.data.token) {\r\n        console.log('res.data.data.token=', res.data)\r\n        setIMToken(res.data.data.token);\r\n        connectIM(res.data.data.userID, res.data.data.token)\r\n      }\r\n      // connectIM(res.data.data.userID, res.data.data.token);\r\n    }\r\n  });\r\n};"],"names":["openIM","setTotalIM","imRegister","setIMToken","imLogin"],"mappings":";;;;;AAqBA,MAAM,gBAAgB,MAAM;AAC1BA,sBACG,yBACA,KAAK,CAAC;AAAA,IACL;AAAA,QACI;AACJ,YAAQ,IAAI,0FAA0F,IAAI;AAC1G,YAAQ,IAAI,iBAAiB,OAAO,IAAI,CAAC;AAEzCC,6BAAW,OAAO,IAAI,CAAC;AAAA,GACxB,EACA,MAAM,CAAC,QAAQ;AACd,YAAQ,IAAI,QAAQ,GAAG;AAAA,GACxB;AACL;AAEA,MAAM,gBAAgB,MAAM;AAC1BD,sBAAO,GAAG,oBAAoB,CAAC,SAAS;AACtC,UAAM,cAAc,KAAK,MAAM,KAAK,IAAI;AACxC,QAAI,YAAY,gBAAgB,KAAK;AACnC;;GAEH;AACH;AAEO,MAAM,YAAY,CAAC,QAAQ,UAAU;AAC1C,UAAQ,IAAI,sCAAsC,QAAQ,KAAK;AAC/D,QAAM,SAAS;AAAA,IACb;AAAA,IACA;AAAA,IAEA,KAAK;AAAA,IACL,YAAY;AAAA;AAEdA,sBACG,MAAM,MAAM,EACZ,KAAK,CAAC,QAAQ;AACb,YAAQ,IAAI,gBAAgB,GAAG;AAC/B,QAAI,IAAI,YAAY,GAAG;AACrB;AACA;;GAEH,EACA,MAAM,CAAC,QAAQ;AACd,YAAQ,IAAI,mBAAmB,GAAG;AAAA,GACnC;AACL;AAEO,MAAM,WAAW,MAAM;AAC5B,QAAM,SAAS;AAAA,IACb,QAAQ;AAAA,IACR,UAAU;AAAA,IACV,aAAa,KAAK,QAAQ;AAAA;AAE5BE,oBAAW,MAAM,EAAE,KAAK,CAAC,QAAQ;AAC/B,YAAQ,IAAI,eAAe,GAAG;AAC9B,QAAI,IAAI,eAAe,KAAK;AAC1B,cAAQ,IAAI,2BAA2B,IAAI,KAAK,KAAK,KAAK;AAC1DC,4BAAW,IAAI,KAAK,KAAK,KAAK;AAAA;GAGjC;AACH;AACY,MAAC,QAAQ,MAAM;AACzB,QAAM,SAAS;AAAA,IACb,QAAQ;AAAA,IACR,UAAU;AAAA,IACV,aAAa,KAAK,QAAQ;AAAA;AAE5BC,iBAAQ,MAAM,EAAE,KAAK,CAAC,QAAQ;AAC5B,YAAQ,IAAI,eAAe,GAAG;AAC9B,QAAI,IAAI,eAAe,KAAK;AAC1B,UAAI,IAAI,KAAK,YAAY,GAAG;AAC1B;AACA;AAAA;AAEF,UAAI,IAAI,KAAK,KAAK,OAAO;AACvB,gBAAQ,IAAI,wBAAwB,IAAI,IAAI;AAC5CD,8BAAW,IAAI,KAAK,KAAK,KAAK;AAC9B,kBAAU,IAAI,KAAK,KAAK,QAAQ,IAAI,KAAK,KAAK,KAAK;AAAA;;GAIxD;AACH;;"}