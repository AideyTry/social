{"version":3,"file":"im.js","sources":["../../../../src/utils/im.js"],"sourcesContent":["/*\r\n * @Author: Aiden(戴林波)\r\n * @Date: 2022-05-11 22:49:17\r\n * @LastEditTime: 2022-05-15 14:26:02\r\n * @LastEditors: Aiden(戴林波)\r\n * @Description: \r\n * @Email: jason_dlb@sina.cn\r\n */\r\nimport {\r\n  imRegister,\r\n  imLogin\r\n} from \"@/api/im.js\";\r\nimport {\r\n  setIMToken\r\n} from \"@/utils/auth.js\";\r\nimport {\r\n  setTotalIM\r\n} from \"@/utils/storage.js\";\r\nimport openIM from \"@/utils/openIM.js\";\r\n\r\n\r\nconst unReadMessage = () => {\r\n  openIM\r\n    .getTotalUnreadMsgCount()\r\n    .then(({\r\n      data\r\n    }) => {\r\n      console.log(\"data==================================================================================\", data);\r\n      console.log('Number(data)=', Number(data))\r\n      // uni.$emit('updateIMMsgCount',{total: Number(data)})\r\n      setTotalIM(Number(data))\r\n    })\r\n    .catch((err) => {\r\n      console.log(\"err=\", err);\r\n    });\r\n};\r\n\r\nconst monitorOnRecv = () => {\r\n  openIM.on(\"OnRecvNewMessage\", (data) => {\r\n    const RecvMessage = JSON.parse(data.data);\r\n    if (RecvMessage.contentType === 101) {\r\n      unReadMessage()\r\n    }\r\n  });\r\n};\r\n\r\nexport const connectIM = (userID, token) => {\r\n  console.log(\"userID, token=====================\", userID, token);\r\n  const config = {\r\n    userID,\r\n    token,\r\n    // url: \"ws://42.192.229.151/:10003\",\r\n    url: \"wss://mancao.social:20038\",\r\n    platformID: 5,\r\n  };\r\n  openIM\r\n    .login(config)\r\n    .then((res) => {\r\n      console.log(\"login suc...\", res);\r\n      if (res.errCode === 0) {\r\n        unReadMessage()\r\n        monitorOnRecv()\r\n      }\r\n    })\r\n    .catch((err) => {\r\n      console.log(\"login failed...\", err);\r\n    });\r\n}\r\n\r\nexport const register = () => {\r\n  const params = {\r\n    secret: \"tuoyun\",\r\n    platform: 5,\r\n    operationID: Date.now() + \"\",\r\n  };\r\n  imRegister(params).then((res) => {\r\n    console.log(\"res========\", res);\r\n    if (res.statusCode === 200) {\r\n      console.log('res.data.data.token====', res.data.data.token)\r\n      setIMToken(res.data.data.token);\r\n      // connectIM(res.data.data.userID, res.data.data.token);\r\n    }\r\n  });\r\n};\r\nexport const login = () => {\r\n  const params = {\r\n    secret: \"tuoyun\",\r\n    platform: 5,\r\n    operationID: Date.now() + \"\",\r\n  };\r\n  imLogin(params).then((res) => {\r\n    console.log(\"res========\", res);\r\n    if (res.statusCode === 200) {\r\n      if (res.data.errCode !== 0) {\r\n        register();\r\n        return;\r\n      }\r\n      if (res.data.data.token) {\r\n        console.log('res.data.data.token=', res.data)\r\n        setIMToken(res.data.data.token);\r\n        connectIM(res.data.data.userID, res.data.data.token)\r\n      }\r\n      // connectIM(res.data.data.userID, res.data.data.token);\r\n    }\r\n  });\r\n};"],"names":["openIM","setTotalIM","imRegister","setIMToken","imLogin"],"mappings":"qHAqBA,KAAM,GAAgB,IAAM,CAC1BA,SACG,yBACA,KAAK,CAAC,CACL,UACI,CACJ,QAAQ,IAAI,yFAA0F,CAAI,EAC1G,QAAQ,IAAI,gBAAiB,OAAO,CAAI,CAAC,EAEzCC,aAAW,OAAO,CAAI,CAAC,EACxB,EACA,MAAM,AAAC,GAAQ,CACd,QAAQ,IAAI,OAAQ,CAAG,EACxB,CACL,EAEM,EAAgB,IAAM,CAC1BD,SAAO,GAAG,mBAAoB,AAAC,GAAS,CAEtC,AAAI,AADgB,KAAK,MAAM,EAAK,IAAI,EACxB,cAAgB,KAC9B,IAEH,CACH,EAEa,EAAY,CAAC,EAAQ,IAAU,CAC1C,QAAQ,IAAI,qCAAsC,EAAQ,CAAK,EAC/D,KAAM,GAAS,CACb,SACA,QAEA,IAAK,4BACL,WAAY,GAEdA,SACG,MAAM,CAAM,EACZ,KAAK,AAAC,GAAQ,CACb,QAAQ,IAAI,eAAgB,CAAG,EAC3B,EAAI,UAAY,GAClB,KACA,KAEH,EACA,MAAM,AAAC,GAAQ,CACd,QAAQ,IAAI,kBAAmB,CAAG,EACnC,CACL,EAEa,EAAW,IAAM,CAC5B,KAAM,GAAS,CACb,OAAQ,SACR,SAAU,EACV,YAAa,KAAK,MAAQ,IAE5BE,aAAW,CAAM,EAAE,KAAK,AAAC,GAAQ,CAC/B,QAAQ,IAAI,cAAe,CAAG,EAC1B,EAAI,aAAe,KACrB,SAAQ,IAAI,0BAA2B,EAAI,KAAK,KAAK,KAAK,EAC1DC,aAAW,EAAI,KAAK,KAAK,KAAK,GAGjC,CACH,EACa,EAAQ,IAAM,CACzB,KAAM,GAAS,CACb,OAAQ,SACR,SAAU,EACV,YAAa,KAAK,MAAQ,IAE5BC,UAAQ,CAAM,EAAE,KAAK,AAAC,GAAQ,CAE5B,GADA,QAAQ,IAAI,cAAe,CAAG,EAC1B,EAAI,aAAe,IAAK,CAC1B,GAAI,EAAI,KAAK,UAAY,EAAG,CAC1B,IACA,OAEF,AAAI,EAAI,KAAK,KAAK,OAChB,SAAQ,IAAI,uBAAwB,EAAI,IAAI,EAC5CD,aAAW,EAAI,KAAK,KAAK,KAAK,EAC9B,EAAU,EAAI,KAAK,KAAK,OAAQ,EAAI,KAAK,KAAK,KAAK,IAIxD,CACH"}