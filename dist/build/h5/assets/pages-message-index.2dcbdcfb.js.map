{"version":3,"file":"pages-message-index.2dcbdcfb.js","sources":["../../../../src/pages/message/index.vue"],"sourcesContent":["<!--\r\n * @Author: Aiden(戴林波)\r\n * @Date: 2021-12-17 17:50:38\r\n * @LastEditTime: 2022-05-11 16:30:33\r\n * @LastEditors: Aiden(戴林波)\r\n * @Description: \r\n * @Email: jason_dlb@sina.cn\r\n-->\r\n<template>\r\n  <view>\r\n    <view\r\n      v-for=\"item in convers\"\r\n      :key=\"item.userID\"\r\n      class=\"conver\"\r\n      @click=\"goChat(item)\"\r\n    >\r\n      <view class=\"conver-msg\">\r\n        <view class=\"chat_bg_msg_icon-wraper\">\r\n          <image\r\n            :src=\"\r\n              item.faceURL && item.faceURL.includes('https://')\r\n                ? item.faceURL\r\n                : defaultAvatar\r\n            \"\r\n            class=\"chat_bg_msg_icon\"\r\n          />\r\n          <view class=\"unread-total\" v-if=\"unReadTotal\"\r\n            ><text>{{ unReadTotal }}</text></view\r\n          >\r\n        </view>\r\n        <view class=\"content-wraper\">\r\n          <text>{{ item.showName }}</text>\r\n          <text>{{ showLastMessage(item.latestMsg) }}</text>\r\n        </view>\r\n      </view>\r\n      <text class=\"conver-time\">{{\r\n        $filters.formatMsgDate(item.latestMsgSendTime)\r\n      }}</text>\r\n    </view>\r\n  </view>\r\n</template>\r\n\r\n<script>\r\nimport { onMounted, computed, ref, watch } from \"vue\";\r\nimport openIM from \"@/utils/openIM.js\";\r\nimport { getIMToken } from \"../../utils/auth.js\";\r\nimport { useStore } from \"vuex\";\r\nimport ChatContent from \"./ChatContent.vue\";\r\nexport default {\r\n  components: {\r\n    ChatContent,\r\n  },\r\n  onShow(){\r\n    console.log('show======')\r\n    this.getAllConversationList()\r\n  },\r\n  setup() {\r\n    const defaultAvatar = \"/static/images/default_avatar.png\";\r\n    const store = useStore();\r\n    const userInfo = computed(() => store.state.user.userInfo).value;\r\n    let operationID = ref(null);\r\n    const convers = ref([]);\r\n    const goChat = (item) => {\r\n      console.log(\"item=\", item);\r\n      uni.navigateTo({\r\n        url: `/pages/message/Chat?userID=${item.userID}&title=${item.showName}`,\r\n      });\r\n    };\r\n    const getAllConversationList = () => {\r\n      openIM\r\n        .getAllConversationList()\r\n        .then(({ data }) => {\r\n          console.log(\"data====\", JSON.parse(data));\r\n          convers.value = JSON.parse(data);\r\n          unReadMessage();\r\n        })\r\n        .catch((err) => {\r\n          console.log(\"err=\", err);\r\n        });\r\n    };\r\n    const getUnReadMsg = () => {\r\n      // debugger\r\n      openIM.on('OnTotalUnreadMessageCountChanged',(data)=>{\r\n        console.log('data unredd=================', data)\r\n        // debugger\r\n})\r\n    }\r\n    const connectIM = (userID, token) => {\r\n      console.log(\"userID, token=====================\", userID, token);\r\n      const config = {\r\n        userID,\r\n        token,\r\n        // url: \"ws://42.192.229.151/:10003\",\r\n        url: \"wss://mancao.social:20038\",\r\n        platformID: 5,\r\n      };\r\n      openIM\r\n        .login(config)\r\n        .then((res) => {\r\n          console.log(\"login suc...\", res);\r\n          if (res.errCode === 0) {\r\n            getAllConversationList();\r\n            getUnReadMsg()\r\n          }\r\n          operationID.value = res.operationID;\r\n          //         openIM.getAllConversationList().then(res=>{\r\n          // //注意 会话对象中latestMsg（会话最后一条消息）仍为Json字符串格式 若需要使用请自行转换\r\n          //         console.log('回话=', JSON.parse(res.data))\r\n          //         console.log('列表信息=', JSON.parse(JSON.parse(res.data)[0].latestMsg))\r\n          //       }).catch(err=>{\r\n\r\n          //       })\r\n          //   const options = {\r\n          //   offset: 0,\r\n          //   count: 20\r\n          // }\r\n          // openIM.getConversationListSplit(options).then(({ data })=>{\r\n          //   console.log('获取的数据=', data)\r\n          // }).catch(err=>{\r\n          //   console.log('err===', err)\r\n          // })\r\n        })\r\n        .catch((err) => {\r\n          console.log(\"login failed...\", err);\r\n        });\r\n    };\r\n\r\n    const showLastMessage = (lastData) => {\r\n      return JSON.parse(lastData).content;\r\n    };\r\n\r\n    let unReadTotal = ref(\"\");\r\n\r\n    const unReadMessage = () => {\r\n      openIM\r\n        .getTotalUnreadMsgCount()\r\n        .then(({ data }) => {\r\n          console.log(\"data===\", data);\r\n          console.log('Number(data)=', Number(data))\r\n          unReadTotal.value = Number(data);\r\n          if(Number(data) > 0){\r\n          uni.setTabBarBadge({\r\n            index: 2,\r\n            text: '···'\r\n          });\r\n          }else {\r\n            uni.removeTabBarBadge({\r\n              index: 2\r\n            })\r\n          }\r\n        })\r\n        .catch((err) => {\r\n          console.log(\"err=\", err);\r\n        });\r\n    };\r\n\r\n    const monitorOnRecv = () => {\r\n      openIM.on(\"OnRecvNewMessage\", (data) => {\r\n        const RecvMessage = JSON.parse(data.data);\r\n        if (RecvMessage.contentType === 101) {\r\n          getAllConversationList();\r\n        }\r\n      });\r\n    };\r\n\r\n    onMounted(() => {\r\n      connectIM(userInfo.phone, getIMToken());\r\n      monitorOnRecv();\r\n      // login();\r\n      // resiger()\r\n    });\r\n    return {\r\n      defaultAvatar,\r\n      operationID,\r\n      convers,\r\n      unReadTotal,\r\n      goChat,\r\n      showLastMessage,\r\n      getAllConversationList\r\n    };\r\n  },\r\n};\r\n</script>\r\n\r\n<style scoped lang=\"scss\">\r\n.conver {\r\n  display: flex;\r\n  justify-content: space-between;\r\n  border-bottom: 1rpx solid #dbdbdb;\r\n  padding: 10rpx;\r\n  .conver-msg {\r\n    display: flex;\r\n  }\r\n  .chat_bg_msg_icon-wraper {\r\n    position: relative;\r\n  }\r\n  .unread-total {\r\n    position: absolute;\r\n    right: -12rpx;\r\n    top: -8rpx;\r\n    width: auto;\r\n    height: auto;\r\n    border-radius: 50%;\r\n    padding: 4rpx;\r\n    background: #f00;\r\n    color: #fff;\r\n    font-size: 12rpx;\r\n    display: flex;\r\n    justify-content: center;\r\n    align-items: center;\r\n  }\r\n  .chat_bg_msg_icon {\r\n    width: 84rpx;\r\n    height: 84rpx;\r\n  }\r\n  .content-wraper {\r\n    display: flex;\r\n    flex-direction: column;\r\n    margin: 0 12rpx;\r\n    background-color: #f2f2f2;\r\n  }\r\n  .conver-time {\r\n  }\r\n}\r\n</style>\r\n"],"names":["components","ChatContent","onShow","log","getAllConversationList","setup","store","useStore","userInfo","computed","state","user","value","operationID","ref","convers","then","data","JSON","parse","catch","err","connectIM","userID","token","config","url","platformID","login","res","errCode","on","unReadTotal","unReadMessage","getTotalUnreadMsgCount","Number","index","text","phone","getIMToken","contentType","defaultAvatar","goChat","item","showName","showLastMessage","lastData","content","key","class"],"mappings":"mXAiDEA,WAAY,CACVC,YAAAA,GAEFC,iBACUC,IAAI,mBACPC,0BAEPC,cAEQC,EAAQC,IACRC,EAAWC,GAAS,IAAMH,EAAMI,MAAMC,KAAKH,WAAUI,UACvDC,EAAcC,EAAI,YAChBC,EAAUD,EAAI,IAOdV,EAAyB,OAE1BA,yBACAY,MAAK,EAAGC,KAAAA,cACCd,IAAI,WAAYe,KAAKC,MAAMF,MAC3BL,MAAQM,KAAKC,MAAMF,UAG5BG,OAAOC,YACElB,IAAI,OAAQkB,OAUpBC,EAAY,CAACC,EAAQC,aACjBrB,IAAI,qCAAsCoB,EAAQC,SACpDC,EAAS,CACbF,OAAAA,EACAC,MAAAA,EAEAE,IAAK,4BACLC,WAAY,KAGXC,MAAMH,GACNT,MAAMa,YACG1B,IAAI,eAAgB0B,GACR,IAAhBA,EAAIC,gBAlBLC,GAAG,oCAAoCd,YACpCd,IAAI,+BAAgCc,SAqB9BL,MAAQiB,EAAIhB,eAkBzBO,OAAOC,YACElB,IAAI,kBAAmBkB,WAQjCW,EAAclB,EAAI,UAEhBmB,EAAgB,OAEjBC,yBACAlB,MAAK,EAAGC,KAAAA,cACCd,IAAI,UAAWc,WACfd,IAAI,gBAAiBgC,OAAOlB,MACxBL,MAAQuB,OAAOlB,GACxBkB,OAAOlB,GAAQ,IACC,CACjBmB,MAAO,EACPC,KAAM,UAGgB,CACpBD,MAAO,OAIZhB,OAAOC,YACElB,IAAI,OAAQkB,iBAahB,OACEb,EAAS8B,MAAOC,OATnBR,GAAG,oBAAqBd,IAEG,MADZC,KAAKC,MAAMF,EAAKA,MACpBuB,uBAYb,CACLC,cAnHoB,oCAoHpB5B,YAAAA,EACAE,QAAAA,EACAiB,YAAAA,EACAU,OAlHcC,YACNxC,IAAI,QAASwC,KACN,CACbjB,IAAK,8BAA8BiB,EAAKpB,gBAAgBoB,EAAKC,cAgH/DC,gBAlDuBC,GAChB5B,KAAKC,MAAM2B,GAAUC,QAkD5B3C,uBAAAA,uIArKA4C,IAAKL,SACJM,MAAK,uKAKuGN,+BAAoBA,4FAOvHK,IAAK"}