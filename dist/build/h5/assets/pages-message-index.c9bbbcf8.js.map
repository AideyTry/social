{"version":3,"file":"pages-message-index.c9bbbcf8.js","sources":["../../../../src/pages/message/index.vue"],"sourcesContent":["<!--\r\n * @Author: Aiden(戴林波)\r\n * @Date: 2021-12-17 17:50:38\r\n * @LastEditTime: 2022-07-25 00:35:56\r\n * @LastEditors: Aiden(戴林波)\r\n * @Description: \r\n * @Email: jason_dlb@sina.cn\r\n-->\r\n<template>\r\n  <view class=\"message-wrapper\">\r\n    <view\r\n      v-for=\"item in convers\"\r\n      :key=\"item.userID\"\r\n      class=\"conver\"\r\n      @click=\"goChat(item)\"\r\n    >\r\n      <view class=\"conver-msg\">\r\n        <view class=\"chat_bg_msg_icon-wraper\">\r\n          <image\r\n            :src=\"\r\n              item.faceURL && item.faceURL.includes('https://')\r\n                ? item.faceURL\r\n                : defaultAvatar\r\n            \"\r\n            class=\"chat_bg_msg_icon\"\r\n          />\r\n          <view class=\"unread-total\" v-if=\"item.unreadCount\"\r\n            ><text>{{ item.unreadCount }}</text></view\r\n          >\r\n        </view>\r\n        <view class=\"content-wraper\">\r\n          <text>{{ item.showName }}</text>\r\n          <text>{{ showLastMessage(item.latestMsg) }}</text>\r\n        </view>\r\n      </view>\r\n      <text class=\"conver-time\">{{\r\n        $filters.formatMsgDate(item.latestMsgSendTime)\r\n      }}</text>\r\n    </view>\r\n    <view v-if=\"convers.length <= 0\" class=\"empty\">\r\n      <view>您还未发起聊天</view>\r\n      <view class=\"empty-content\">可以去关注兴趣爱好发布者，然后到“我的”模块中点击关注，进入关注的用户或者粉丝一起聊天吧~！</view>\r\n    </view>\r\n  </view>\r\n</template>\r\n\r\n<script>\r\nimport { onMounted, computed, ref, watch } from \"vue\";\r\nimport openIM from \"@/utils/openIM.js\";\r\nimport { getIMToken } from \"../../utils/auth.js\";\r\nimport { useStore } from \"vuex\";\r\nimport ChatContent from \"./ChatContent.vue\";\r\nexport default {\r\n  components: {\r\n    ChatContent,\r\n  },\r\n  onShow(){\r\n    console.log('show======')\r\n    this.getAllConversationList()\r\n  },\r\n  setup() {\r\n    const defaultAvatar = \"/static/images/default_avatar.png\";\r\n    const store = useStore();\r\n    const userInfo = computed(() => store.state.user.userInfo).value;\r\n    const convers = ref([]);\r\n    const goChat = (item) => {\r\n      console.log(\"item=\", item);\r\n      uni.navigateTo({\r\n        url: `/pages/message/Chat?userID=${item.userID}&title=${item.showName}&conversationID=${item.conversationID}`,\r\n      });\r\n    };\r\n    const getAllConversationList = () => {\r\n      openIM\r\n        .getAllConversationList()\r\n        .then(({ data }) => {\r\n          console.log(\"会话总数data====\", JSON.parse(data));\r\n          convers.value = JSON.parse(data);\r\n          unReadMessage();\r\n        })\r\n        .catch((err) => {\r\n          console.log(\"err=\", err);\r\n        });\r\n    };\r\n    const connectIM = (userID, token) => {\r\n      console.log(\"userID, token=====================\", userID, token);\r\n      const config = {\r\n        userID,\r\n        token,\r\n        // url: \"ws://42.192.229.151/:10003\",\r\n        url: \"wss://mancao.social:20038\",\r\n        platformID: 5,\r\n      };\r\n      openIM\r\n        .login(config)\r\n        .then((res) => {\r\n          console.log(\"login suc...\", res);\r\n          if (res.errCode === 0) {\r\n            getAllConversationList();\r\n          }\r\n        })\r\n        .catch((err) => {\r\n          console.log(\"login failed...\", err);\r\n        });\r\n    };\r\n\r\n    const showLastMessage = (lastData) => {\r\n      return JSON.parse(lastData).content;\r\n    };\r\n\r\n    const unReadMessage = () => {\r\n      openIM\r\n        .getTotalUnreadMsgCount()\r\n        .then(({ data }) => {\r\n          console.log(\"data===\", data);\r\n          console.log('Number(data)=', Number(data))\r\n          if(Number(data) > 0){\r\n          uni.setTabBarBadge({\r\n            index: 2,\r\n            text: '···'\r\n          });\r\n          }else {\r\n            uni.removeTabBarBadge({\r\n              index: 2\r\n            })\r\n          }\r\n        })\r\n        .catch((err) => {\r\n          console.log(\"err=\", err);\r\n        });\r\n    };\r\n\r\n    const monitorOnRecv = () => {\r\n      openIM.on(\"OnRecvNewMessage\", (data) => {\r\n        const RecvMessage = JSON.parse(data.data);\r\n        if (RecvMessage.contentType === 101) {\r\n          getAllConversationList();\r\n        }\r\n      });\r\n    };\r\n\r\n    onMounted(() => {\r\n      connectIM(userInfo.phone, getIMToken());\r\n      monitorOnRecv();\r\n      // login();\r\n      // resiger()\r\n    });\r\n    return {\r\n      defaultAvatar,\r\n      convers,\r\n      goChat,\r\n      showLastMessage,\r\n      getAllConversationList\r\n    };\r\n  },\r\n};\r\n</script>\r\n\r\n<style scoped lang=\"scss\">\r\n.empty{\r\n  padding-top: 48rpx;\r\n  display: flex;\r\n  flex-direction: column;\r\n  justify-content: center;\r\n  align-items: center;\r\n  color: #a0a0a0;\r\n  .empty-content{\r\n    text-indent:2em;\r\n  }\r\n}\r\n.conver {\r\n  display: flex;\r\n  justify-content: space-between;\r\n  border-bottom: 1rpx solid #dbdbdb;\r\n  padding: 10rpx;\r\n  .conver-msg {\r\n    display: flex;\r\n  }\r\n  .chat_bg_msg_icon-wraper {\r\n    position: relative;\r\n  }\r\n  .unread-total {\r\n    position: absolute;\r\n    right: -12rpx;\r\n    top: -8rpx;\r\n    width: auto;\r\n    height: auto;\r\n    border-radius: 50%;\r\n    padding: 4rpx;\r\n    background: #f00;\r\n    color: #fff;\r\n    font-size: 12rpx;\r\n    display: flex;\r\n    justify-content: center;\r\n    align-items: center;\r\n  }\r\n  .chat_bg_msg_icon {\r\n    width: 84rpx;\r\n    height: 84rpx;\r\n  }\r\n  .content-wraper {\r\n    display: flex;\r\n    flex-direction: column;\r\n    margin: 0 12rpx;\r\n    background-color: #f2f2f2;\r\n  }\r\n  .conver-time {\r\n  }\r\n}\r\n</style>\r\n"],"names":["components","ChatContent","onShow","log","getAllConversationList","setup","store","useStore","userInfo","computed","state","user","value","convers","ref","then","data","JSON","parse","catch","err","unReadMessage","getTotalUnreadMsgCount","Number","index","text","userID","token","config","url","platformID","login","res","errCode","phone","getIMToken","on","contentType","defaultAvatar","goChat","item","showName","conversationID","showLastMessage","lastData","content","_createBlock","_component_v_uni_view","class","_createElementBlock","_Fragment","$setup","key","onClick","_createVNode","_component_v_uni_image","src","faceURL","includes","unreadCount","_component_v_uni_text","latestMsg","_ctx","formatMsgDate","latestMsgSendTime","length"],"mappings":"+SAqDEA,WAAY,CACVC,YAAAA,GAEFC,iBACUC,IAAI,mBACPC,0BAEPC,cAEQC,EAAQC,IACRC,EAAWC,GAAS,IAAMH,EAAMI,MAAMC,KAAKH,WAAUI,MACrDC,EAAUC,EAAI,IAOdV,EAAyB,OAE1BA,yBACAW,MAAK,EAAGC,KAAAA,cACCb,IAAI,eAAgBc,KAAKC,MAAMF,MAC/BJ,MAAQK,KAAKC,MAAMF,UAG5BG,OAAOC,YACEjB,IAAI,OAAQiB,OA6BpBC,EAAgB,OAEjBC,yBACAP,MAAK,EAAGC,KAAAA,cACCb,IAAI,UAAWa,WACfb,IAAI,gBAAiBoB,OAAOP,IACjCO,OAAOP,GAAQ,IACC,CACjBQ,MAAO,EACPC,KAAM,UAGgB,CACpBD,MAAO,OAIZL,OAAOC,YACEjB,IAAI,OAAQiB,iBAahB,KAzDQ,EAACM,EAAQC,aACjBxB,IAAI,qCAAsCuB,EAAQC,SACpDC,EAAS,CACbF,OAAAA,EACAC,MAAAA,EAEAE,IAAK,4BACLC,WAAY,KAGXC,MAAMH,GACNb,MAAMiB,YACG7B,IAAI,eAAgB6B,GACR,IAAhBA,EAAIC,gBAITd,OAAOC,YACEjB,IAAI,kBAAmBiB,QAwCzBZ,EAAS0B,MAAOC,OATnBC,GAAG,oBAAqBpB,IAEG,MADZC,KAAKC,MAAMF,EAAKA,MACpBqB,uBAYb,CACLC,cAtFoB,oCAuFpBzB,QAAAA,EACA0B,OApFcC,YACNrC,IAAI,QAASqC,KACN,CACbX,IAAK,8BAA8BW,EAAKd,gBAAgBc,EAAKC,2BAA2BD,EAAKE,oBAkF/FC,gBA7CuBC,GAChB3B,KAAKC,MAAM0B,GAAUC,QA6C5BzC,uBAAAA,mEA9IJ0C,EAkCOC,GAlCDC,MAAM,+BAER,YADFC,EA4BOC,SA3BUC,WAARX,QADTM,EA4BOC,GA1BJK,IAAKZ,EAAKd,OACXsB,MAAM,SACLK,WAAOF,SAAOX,gBAEf,KAAAc,EAkBOP,GAlBDC,MAAM,0BACV,KAAAM,EAYOP,GAZDC,MAAM,uCACV,KAAAM,EAOEC,GANCC,IAAqBhB,EAAKiB,SAAWjB,EAAKiB,QAAQC,qBAAwClB,EAAKiB,QAA2BN,gBAK3HH,MAAM,oCAEyBR,EAAKmB,iBAAtCb,EAECC,SAFKC,MAAM,4BACT,KAAAM,EAAmCM,mBAA7B,SAAGpB,EAAKmB,wEAGnBL,EAGOP,GAHDC,MAAM,8BACV,KAAAM,EAAgCM,mBAA1B,SAAGpB,EAAKC,2BACda,EAAkDM,mBAA5C,SAAGT,kBAAgBX,EAAKqB,yDAGlCP,EAESM,GAFHZ,MAAM,2BAAc,SACxBc,WAASC,cAAcvB,EAAKwB,wEAGpBb,UAAQc,eAApBnB,EAGOC,SAH0BC,MAAM,qBACrC,KAAAM,EAAoBP,mBAAd,OAAA,oBACNO,EAAiFP,GAA3EC,MAAM,6BAAgB,OAAA"}