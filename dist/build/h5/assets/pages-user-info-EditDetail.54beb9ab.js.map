{"version":3,"file":"pages-user-info-EditDetail.54beb9ab.js","sources":["../../../../src/pages/user/info/EditDetail.vue"],"sourcesContent":["<template>\r\n  <div class=\"hobby-detail\">\r\n    <uni-forms ref=\"form\" :modelValue=\"hobbyInfo\">\r\n      <view class=\"author-wraper\">\r\n        <view class=\"author\">\r\n          <view @click=\"goBack\">返回</view>\r\n          <view class=\"author-info\">\r\n            <image\r\n              class=\"avatar\"\r\n              mode=\"aspectFit\"\r\n              :src=\"hobbyInfo.avatar || ''\"\r\n            ></image>\r\n            <text>{{ hobbyInfo.username || \"\" }}</text>\r\n          </view>\r\n        </view>\r\n      </view>\r\n      <scroll-view\r\n        scroll-x=\"true\"\r\n        class=\"photos\"\r\n        v-if=\"hobbyInfo.fileType === 0\"\r\n      >\r\n        <view class=\"photos\">\r\n          <view\r\n            class=\"photo-wraper\"\r\n            v-for=\"(item, index) in photos\"\r\n            :key=\"index\"\r\n          >\r\n            <image\r\n              mode=\"aspectFill\"\r\n              :src=\"item.path\"\r\n              class=\"photo\"\r\n              @click=\"onEdit(item, index)\"\r\n            ></image>\r\n          </view>\r\n          <view class=\"photo-add-wraper\" @click=\"addImage\">\r\n            <text class=\"photo-add\">+</text>\r\n          </view>\r\n        </view>\r\n      </scroll-view>\r\n      <view class=\"swiper-box\" v-if=\"hobbyInfo.fileType === 1\">\r\n        <view class=\"swiper-item\">\r\n          <VideoPlayer\r\n            :options=\"{ src: hobbyInfo.video_url, poster: hobbyInfo.url }\"\r\n            :key=\"hobbyInfo.id\"\r\n          ></VideoPlayer>\r\n        </view>\r\n      </view>\r\n      <view class=\"content-wraper\">\r\n        <view class=\"content\">\r\n          <view class=\"title\">\r\n            <uni-forms-item name=\"title\">\r\n              <input\r\n                v-model=\"hobbyInfo.title\"\r\n                type=\"text\"\r\n                placeholder=\"请输入文本\"\r\n                @confirm=\"changeTitle\"\r\n              />\r\n            </uni-forms-item>\r\n          </view>\r\n          <view class=\"main\">\r\n            <uni-forms-item name=\"content\">\r\n              <input\r\n                v-model=\"hobbyInfo.content\"\r\n                type=\"text\"\r\n                placeholder=\"请输入文本\"\r\n                @confirm=\"changeContent\"\r\n              />\r\n            </uni-forms-item>\r\n          </view>\r\n          <view class=\"publish-date\"\r\n            ><text>发布于: </text><text>{{ publishDate }}</text></view\r\n          >\r\n        </view>\r\n      </view>\r\n      <view class=\"comment-wraper\">\r\n        <Comment\r\n          v-if=\"hobbyInfo.id\"\r\n          :hobbyInfo=\"hobbyInfo\"\r\n          :key=\"hobbyInfo.id\"\r\n        />\r\n      </view>\r\n    </uni-forms>\r\n    <view class=\"submit-wraper\">\r\n      <button @click=\"submit\" class=\"submit\">发 布</button>\r\n    </view>\r\n  </div>\r\n</template>\r\n\r\n<script>\r\nimport { ref, reactive, onMounted, computed, toRefs  } from \"vue\";\r\nimport { useStore } from \"vuex\";\r\nimport qs from \"qs\";\r\n\r\nimport { getHobbyDetail } from \"@/api/hobby.js\";\r\nimport { deletePublish, updatePublish, updateVideoPublish } from \"@/api/publish.js\";\r\nimport { setFollow, getFollow, deleteFollow } from \"@/api/communication.js\";\r\nimport Comment from \"@/pages/components/Comment.vue\";\r\nimport VideoPlayer from \"@/pages/components/VideoPlayer.vue\";\r\n\r\nimport { formatDate } from \"@/utils/util.js\";\r\nimport { fileParse } from \"@/utils/util.js\";\r\n\r\nexport default {\r\n  components: {\r\n    Comment,\r\n    VideoPlayer,\r\n  },\r\n  onLoad: function(options) {\r\n    console.log(\"options===\", options);\r\n  },\r\n  onReady: function() {},\r\n  setup(props) {\r\n    console.log(\"props=\", props);\r\n    const store = useStore();\r\n    const userInfo = computed(() => store.state.user.userInfo).value;\r\n\r\n    const options = reactive({\r\n      poster: \"\",\r\n      src: \"\", //视频源\r\n    });\r\n\r\n    let info = ref([\r\n      {\r\n        content:\r\n          \"https://social-1308251497.cos.ap-guangzhou.myqcloud.com/images/4.jfif\",\r\n      },\r\n    ]);\r\n    let current = ref(0);\r\n    let mode = ref(\"default\");\r\n\r\n    const change = (e) => {\r\n      current.value = e.detail.current;\r\n    };\r\n\r\n    let hobbyInfo = ref({});\r\n    const initGetHobbyDetail = (obj) => {\r\n      const { id, hobby } = obj;\r\n      const params = { id, hobby };\r\n      getHobbyDetail(params).then((data) => {\r\n        if (data.data.code === 200) {\r\n          hobbyInfo.value = data.data.data;\r\n          publishDate.value = formatDate(data.data.data.create_time);\r\n          if(!data.data.data.video_url){\r\n            photos.value = hobbyInfo.value.photos.map((element, index) => ({\r\n              path: element,\r\n            }));\r\n          }\r\n          options.poster = data.data.data.url;\r\n          options.src = data.data.data.video_url;\r\n        }\r\n      });\r\n    };\r\n\r\n    // 返回\r\n    const goBack = () => {\r\n      uni.switchTab({\r\n        url: \"/pages/user/index\",\r\n      });\r\n    };\r\n\r\n    // 发布\r\n    let publishDate = ref(null);\r\n\r\n    // 编辑\r\n    let operations = ref([\"编辑\", \"删除\"]);\r\n    let activeOperationIndex = ref(0);\r\n    const onUpdate = (index) => {\r\n      // photos.value.splice(index, 1);\r\n      uni.chooseImage({\r\n        count: 1, //默认9\r\n        sizeType: [\"original\", \"compressed\"], //可以指定是原图还是压缩图，默认二者都有\r\n        sourceType: [\"album\"], //从相册选择\r\n        success: function(res) {\r\n          const { tempFiles } = res;\r\n          photos.value[index] = tempFiles[0]\r\n        },\r\n      });\r\n    };\r\n    const onDelete = (index) => {\r\n      if (photos.value.length <= 1) {\r\n        uni.showModal({\r\n          content: \"至少需要发布一张图片\",\r\n          confirmText: \"知道了\",\r\n          showCancel: false,\r\n          success: function(res) {\r\n            if (res.confirm) {\r\n              console.log(\"用户点击确定\");\r\n            } else if (res.cancel) {\r\n              console.log(\"用户点击取消\");\r\n            }\r\n          },\r\n        });\r\n        return;\r\n      }\r\n      photos.value.splice(index, 1);\r\n      console.log(\"photos.value===========\", photos.value);\r\n    };\r\n    const onEdit = (item, index) => {\r\n      console.log(\"item, index===\", item, index);\r\n      uni.showActionSheet({\r\n        itemList: operations,\r\n        success: function(res) {\r\n          console.log(\"选中了第\" + (res.tapIndex + 1) + \"个按钮\");\r\n          activeOperationIndex.value = res.tapIndex;\r\n          if (activeOperationIndex.value === 1) {\r\n            onDelete(index);\r\n          } else {\r\n            onUpdate(index);\r\n          }\r\n        },\r\n        fail: function(res) {\r\n          console.log(res.errMsg);\r\n        },\r\n      });\r\n    };\r\n\r\n    // 显示的图片组\r\n    const photos = ref([]);\r\n\r\n    /**\r\n     * @description: 选择添加图片\r\n     * @param {*}\r\n     * @Author:\r\n     * @return {*}\r\n     */\r\n\r\n    const addImage = () => {\r\n      uni.chooseImage({\r\n        count: 6, //默认9\r\n        sizeType: [\"original\", \"compressed\"], //可以指定是原图还是压缩图，默认二者都有\r\n        sourceType: [\"album\"], //从相册选择\r\n        success: function(res) {\r\n          console.log(\"res===\", res);\r\n          const { tempFiles } = res;\r\n          photos.value = photos.value.concat(tempFiles);\r\n          console.log(\"photos.value====\", photos.value);\r\n        },\r\n      });\r\n    };\r\n\r\n    const form = ref(null);\r\n\r\n    const changeTitle = (e) => {\r\n      const { detail: value } = e;\r\n      hobbyInfo.value.title.value = value;\r\n    };\r\n\r\n    const changeContent = (e) => {\r\n      const { detail: value } = e;\r\n      hobbyInfo.value.content.value = value;\r\n    };\r\n\r\n    /**\r\n     * @description: 发布\r\n     * @param {*}\r\n     * @Author:\r\n     * @return {*}\r\n     */\r\n\r\n    const submit = () => {\r\n      form.value\r\n        .validate()\r\n        .then(async (res) => {\r\n          console.log(\"表单数据信息：\", res);\r\n          const { title, content } = res;\r\n          console.log('photos=====', photos.value)\r\n          if(photos.value.length <= 0){\r\n          const params = {\r\n            title,\r\n            id: parseInt(props.id),\r\n            hobby: parseInt(props.hobby),\r\n            content,\r\n          };\r\n            updateVideoPublish(params).then(data => {\r\n            if (data.data.code === 200) {\r\n              uni.showToast({\r\n                title: data.data.msg,\r\n                duration: 2000,\r\n              });\r\n              uni.switchTab({\r\n                url: \"/pages/user/index\",\r\n                success() {\r\n                  let page = getCurrentPages().pop(); //跳转页面成功之后\r\n                  console.log(\"page==============\", page);\r\n                  if (!page) return;\r\n                  page.onLoad(); //如果页面存在，则重新刷新页面\r\n                },\r\n              });\r\n            }\r\n            })\r\n            return\r\n          }\r\n          const tempPhotos = photos.value.map((item, index) => ({\r\n            key: item,\r\n            index\r\n          }))\r\n          const remoteUrls = tempPhotos.filter((item) =>\r\n            item.key.path.includes(\"social-1308251497\")\r\n          );\r\n          const blobUrls = tempPhotos.filter((item) =>\r\n            item.key.path.includes(\"blob:\")\r\n          );\r\n          const fileAll = [];\r\n          for (let item of blobUrls) {\r\n            const chunk = await fileParse(item.key, \"base64\");\r\n            fileAll.push({\r\n              index: item.index,\r\n              filename: item.key.name,\r\n              chunk: chunk,\r\n            });\r\n          }\r\n          // const buffer = await fileParse(tempFiles[0], \"buffer\");\r\n          // const spark = new SparkMD5.ArrayBuffer();\r\n          // spark.append(buffer);\r\n          // const hash = spark.end();\r\n\r\n          const urls = hobbyInfo.value.photos[0].match(/myqcloud.com\\/(\\S*)/)[1];\r\n          const uploadHash = urls.match(/(\\S*)\\//)[1];\r\n          const remotePhotos = remoteUrls.map((item) => ({index: item.index, path:item.key.path}));\r\n          const params = {\r\n            uploadHash,\r\n            uploadFiles: fileAll.length > 0 ? fileAll : [],\r\n            remotePhotos: remotePhotos.length > 0 ?  remotePhotos :  [],\r\n            title,\r\n            id: parseInt(props.id),\r\n            hobby: parseInt(props.hobby),\r\n            content,\r\n          };\r\n          updatePublish(qs.stringify(params)).then((data) => {\r\n            if (data.data.code === 200) {\r\n              uni.showToast({\r\n                title: data.data.msg,\r\n                duration: 2000,\r\n              });\r\n              uni.switchTab({\r\n                url: \"/pages/user/index\",\r\n                success() {\r\n                  let page = getCurrentPages().pop(); //跳转页面成功之后\r\n                  console.log(\"page==============\", page);\r\n                  if (!page) return;\r\n                  page.onLoad(); //如果页面存在，则重新刷新页面\r\n                },\r\n              });\r\n            }\r\n            console.log(\"data=\", data);\r\n          });\r\n        })\r\n        .catch((err) => {\r\n          console.log(\"表单错误信息：\", err);\r\n        });\r\n    };\r\n\r\n    onMounted(() => {\r\n      initGetHobbyDetail({ id: props.id, hobby: props.hobby });\r\n    });\r\n    return {\r\n      hobbyInfo,\r\n      photos,\r\n      info,\r\n      publishDate,\r\n      options,\r\n      goBack,\r\n      onEdit,\r\n      operations,\r\n      activeOperationIndex,\r\n      addImage,\r\n      form,\r\n      changeTitle,\r\n      changeContent,\r\n      submit,\r\n    };\r\n  },\r\n};\r\n</script>\r\n\r\n<style lang=\"scss\" scoped>\r\n.hobby-detail {\r\n  padding: 0 40rpx;\r\n}\r\n.swiper-box {\r\n  width: 100%;\r\n  height: 554rpx;\r\n  .swiper-item {\r\n    width: 100%;\r\n    height: 100%;\r\n    .image {\r\n      width: inherit;\r\n      height: 100%;\r\n    }\r\n  }\r\n}\r\n\r\n.author-wraper {\r\n  margin-top: 32rpx;\r\n  padding: 0 32rpx;\r\n}\r\n.author {\r\n  padding-bottom: 32rpx;\r\n  display: flex;\r\n  justify-content: space-between;\r\n  align-items: center;\r\n  border-bottom: 1px solid #e6e6e6;\r\n  .author-info {\r\n    display: flex;\r\n    align-items: center;\r\n  }\r\n  .avatar {\r\n    width: 52rpx;\r\n    height: 52rpx;\r\n    border-radius: 50%;\r\n    background-color: #ccc;\r\n    margin-right: 20rpx;\r\n  }\r\n}\r\n.content-wraper {\r\n  margin-top: 32rpx;\r\n  padding: 0 32rpx;\r\n  .content {\r\n    padding-bottom: 32rpx;\r\n    border-bottom: 1px solid #e6e6e6;\r\n    .title {\r\n      font-size: 32rpx;\r\n      font-weight: 700;\r\n    }\r\n    .main {\r\n      margin-top: 20rpx;\r\n      color: #555;\r\n      letter-spacing: 6rpx;\r\n      text-indent: 2em;\r\n    }\r\n    .publish-date {\r\n      margin-top: 20rpx;\r\n      color: #999;\r\n      font-size: 24rpx;\r\n    }\r\n  }\r\n}\r\n.comment-wraper {\r\n  margin-top: 32rpx;\r\n  padding: 0 32rpx;\r\n}\r\n.photos {\r\n  display: flex;\r\n  .photo-wraper {\r\n    position: relative;\r\n    margin-right: 20rpx;\r\n    flex-shrink: 0;\r\n    .photo {\r\n      width: 200rpx;\r\n      height: 200rpx;\r\n      border-radius: 20%;\r\n    }\r\n    .photo-add {\r\n      position: absolute;\r\n      left: 50%;\r\n      top: 50%;\r\n      transform: translateY(-50%);\r\n      font-size: 12rpx;\r\n    }\r\n  }\r\n  .photo-add-wraper {\r\n    width: 200rpx;\r\n    height: 200rpx;\r\n    border-radius: 20%;\r\n    position: relative;\r\n    flex-shrink: 0;\r\n    border: 1rpx solid #dfdfdf;\r\n  }\r\n  .photo-add {\r\n    position: absolute;\r\n    left: 50%;\r\n    top: 50%;\r\n    transform: translateY(-50%);\r\n    font-size: 12rpx;\r\n  }\r\n}\r\n.submit-wraper {\r\n  position: fixed;\r\n  bottom: 0;\r\n  left: 0;\r\n  right: 0;\r\n  display: flex;\r\n  justify-content: center;\r\n  .submit {\r\n    background-color: #00faf3;\r\n    color: #363636;\r\n    padding: 0 200rpx;\r\n    border-radius: 60rpx;\r\n  }\r\n}\r\n</style>\r\n"],"names":["components","Comment","VideoPlayer","onLoad","options","log","onReady","setup","props","store","useStore","state","user","userInfo","value","reactive","poster","src","info","ref","content","hobbyInfo","publishDate","operations","activeOperationIndex","photos","form","obj","id","hobby","then","data","code","formatDate","create_time","video_url","map","element","index","path","url","goBack","onEdit","item","itemList","success","res","tapIndex","length","confirmText","showCancel","confirm","cancel","splice","count","sizeType","sourceType","tempFiles","fail","errMsg","addImage","concat","changeTitle","e","detail","title","changeContent","submit","validate","async","params2","parseInt","msg","duration","page","getCurrentPages","pop","tempPhotos","key","remoteUrls","filter","includes","blobUrls","fileAll","chunk","fileParse","push","filename","name","uploadHash","match","remotePhotos","params","uploadFiles","qs","stringify","catch","err","_component_uni_forms","class","mode","type","placeholder","onClick"],"mappings":"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"}