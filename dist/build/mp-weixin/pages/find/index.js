"use strict";var e=require("../../common/vendor.js"),l=require("../../utils/util.js"),a=require("../../api/file.js"),t=require("../../utils/storage.js");if(require("../../utils/request.js"),require("../../utils/auth.js"),!Array){(e.resolveComponent("uni-easyinput")+e.resolveComponent("uni-forms-item")+e.resolveComponent("uni-forms"))()}Math||((()=>"../../uni_modules/uni-easyinput/components/uni-easyinput/uni-easyinput.js")+(()=>"../../uni_modules/uni-forms/components/uni-forms-item/uni-forms-item.js")+(()=>"../../uni_modules/uni-forms/components/uni-forms/uni-forms.js"))();const o={onShow:function(){t.getTotalIM()>0?e.index.setTabBarBadge({index:2,text:"···"}):e.index.removeTabBarBadge({index:2})}},s=Object.assign(o,{setup(t){const o=e.useStore(),s=e.computed$1((()=>o.state.user.userInfo)).value;let u=e.ref(""),r=e.ref(0),n=e.ref(0),i=e.ref([]),c=e.ref("暂停"),f=e.ref(!1),v=e.ref(!1),d=e.ref(!1),p=e.ref(!1),m=e.ref(""),b=e.ref([]),h=e.ref([]);e.ref(0),e.ref(0);const g=async()=>{f.value=!0,h.value=[],console.log("partList.value=",b.value),b.value.forEach(((l,a)=>{h.value.push((()=>((l,a)=>new Promise(((t,o)=>{const s=URL.createObjectURL(l.chunk);console.log("blobUrl===",s),e.index.uploadFile({url:"/prod/files/uploadLargeFile",filePath:s,name:"file",fileType:"video",formData:{filename:l.filename},success:e=>{console.log("uploadFileRes===",e);const{statusCode:l}=e;if(console.log("index================================",a),200===l){let e=b.value;const l=e.splice(0,1);i.value.push(l),b.value=[...e],console.log("partList=",b),console.log("cutPartslength=",i.value.length),console.log("partListLength=",n.value),r.value=(i.value.length/n.value*100).toFixed(2),t(!0)}else t(!1)},fail:e=>{console.log("err=",e)}})})))(l,a)))}));let l=0;const t=async()=>{if(!d.value)if(console.log("abort",d.value),console.log("requestList.value===",h.value),l>=h.value.length)(()=>{console.log("去调用接口合并文件");const{avatar:e,username:l}=s,t={hash:m.value,title:T.title,hobby:T.hobby,fileType:T.fileType,content:T.content,avatar:e,username:l};a.mergeFile(t).then((e=>{console.log("data===",e),f.value=!1,p.value=!1}))})();else try{const e=await h.value[l]();console.log("isStep=",e),e&&l++,t()}catch(e){throw new Error("err happened")}};t()},y=()=>{e.index.chooseVideo({sourceType:["camera","album"],success:function(a){console.log("res===",a),u.value=a.tempFilePath,v.value=!0,(async a=>{console.log("tempFiles===",a),p.value=!0;const t=await l.fileParse(a,"buffer"),o=new e.SparkMD5.ArrayBuffer;let s;o.append(t),m.value=o.end(),s=/\.([0-9a-zA-Z]+)$/i.exec(a.name)[1];const u=524288;let r=0;n.value=Math.ceil(a.size/u),console.log("partListLength=",n.value);for(let e=0;e<n.value;e++){let l={chunk:a.slice(r,r+u),filename:`${m.value}_${e}_.${s}`};r+=u,b.value.push(l)}g()})(a.tempFile)}})},x=()=>{v.value?(c.value="继续",v.value=!1,d.value=!0):(c.value="暂停",v.value=!0,d.value=!1,g())};e.ref(""),e.ref(0);const q=async()=>{e.index.chooseImage({count:6,sizeType:["original","compressed"],sourceType:["album"],success:function(t){(async t=>{if(console.log("image=",t),!t)return;const{tempFilePaths:o,tempFiles:u}=t;p.value=!0;const n=Object.assign([],u),i=[];for(let e of n){const a=await l.fileParse(e,"base64");i.push({filename:e.name,chunk:a})}const c=await l.fileParse(u[0],"buffer"),f=new e.SparkMD5.ArrayBuffer;f.append(c);const v=f.end(),{avatar:d,username:m}=s;a.uploadImage(e.lib.stringify({fileAll:i,hash:v,title:T.title,hobby:parseInt(T.hobby),fileType:T.fileType,content:T.content,avatar:d,username:m})).then((e=>{console.log("data===",e);const{data:{code:l}}=e;200===l&&(r.value=100,p.value=!1)}))})(t)}})},w=e.ref(null);let T=e.reactive({title:"",hobby:"",fileType:"",content:""}),j={title:{rules:[{required:!0,errorMessage:"请输入标题"}]},hobby:{rules:[{required:!0,errorMessage:"请选择兴趣"}]},fileType:{rules:[{required:!0,errorMessage:"请选择文件类型"}]},content:{rules:[{required:!0,errorMessage:"请输入正文内容"}]}},$=e.ref(""),F=e.ref(""),L=e.ref(""),k=e.ref(""),M=e.reactive([{value:0,text:"狼人杀",disable:!1},{value:1,text:"剧本杀",disable:!1},{value:2,text:"登山",disable:!1},{value:3,text:"旅游",disable:!1},{value:4,text:"视频",disable:!1}]),P=e.ref([{value:0,text:"图片",disable:!1},{value:1,text:"视频",disable:!1}]);const _=e=>{console.log("e=",e);const{detail:{value:l}}=e;L.value=l,w.value.setValue("hobby",l)},B=e=>{const{detail:{value:l}}=e;k.value=l,w.value.setValue("fileType",l)},I=()=>{w.value.validate().then((e=>{console.log("表单数据信息：",e);const{fileType:l,title:a,content:t,hobby:o}=e;T.content=t,T.title=a,T.fileType=l,T.hobby=o,0===l?q():y()})).catch((e=>{console.log("表单错误信息：",e)}))};return e.watch((()=>L.value),(e=>{switch(console.log("state=",e),e){case 0:case 1:P.value=[{value:0,text:"图片",disable:!1}];break;case 2:case 3:P.value=[{value:0,text:"图片",disable:!1},{value:1,text:"视频",disable:!1}];break;case 4:P.value=[{value:1,text:"视频",disable:!1}]}}),{deep:!0}),(l,a)=>e.e({a:e.o$1((l=>e.isRef($)?$.value=l:$=l)),b:e.p({placeholder:"请输入标题",modelValue:e.unref($)}),c:e.p({required:!0,label:"标    题：",name:"title","label-width":"80"}),d:e.f(e.unref(M),((l,a,t)=>({a:l.value,b:l.value,c:e.t(l.text),d:l.value,e:a}))),e:e.o$1(_),f:e.p({required:!0,label:"兴    趣：",name:"hobby","label-width":"80"}),g:e.f(e.unref(P),((l,a,t)=>({a:l.value,b:l.value,c:e.t(l.text),d:l.value,e:l.value}))),h:e.o$1(B),i:e.p({required:!0,label:"文件类型：",name:"fileType","label-width":"80"}),j:e.o$1((l=>e.isRef(F)?F.value=l:F=l)),k:e.p({type:"textarea",autoHeight:!0,placeholder:"请输入正文内容",modelValue:e.unref(F)}),l:e.p({required:!0,label:"内    容：",name:"content","label-width":"80"}),m:e.sr(w,"14a897d3-0",{k:"form"}),n:e.p({modelValue:e.unref(T),rules:e.unref(j)}),o:e.o$1(I),p:e.unref(p)},e.unref(p)?{q:e.unref(r)}:{},{r:e.unref(f)},e.unref(f)?{s:e.t(e.unref(c)),t:e.o$1(x)}:{})}});var u=e._export_sfc(s,[["__scopeId","data-v-14a897d3"]]);wx.createPage(u);
//# sourceMappingURL=index.js.map
