{"version":3,"file":"WaterFall.js","sources":["../../../../../src/pages/index/WaterFall.vue","../../../../../uniComponent:/QzovbXlzZWxmL3NvY2lhbC9zb2NpYWwvc3JjL3BhZ2VzL2luZGV4L1dhdGVyRmFsbC52dWU"],"sourcesContent":["<!--\r\n * @Author: Aiden(戴林波)\r\n * @Date: 2022-02-24 14:06:50\r\n * @LastEditTime: 2022-06-22 15:44:04\r\n * @LastEditors: Aiden(戴林波)\r\n * @Description: \r\n * @Email: jason_dlb@sina.cn\r\n-->\r\n<template>\r\n  <view class=\"waterfall\">\r\n    <view\r\n      class=\"waterfall-item\"\r\n      :style=\"{\r\n        top: item.top + 'rpx',\r\n        left: item.left + 'rpx',\r\n      }\"\r\n      v-for=\"item in waterfallList\"\r\n      :key=\"item.id\"\r\n      @click=\"goDetail(item)\"\r\n    >\r\n      <view class=\"waterfall-image-wrapper\">\r\n      <image\r\n        class=\"waterfall-image\"\r\n        mode=\"widthFix\"\r\n        :style=\"{ width: waterfallImageWidth + 'rpx' }\"\r\n        :src=\"item.src\"\r\n      ></image>\r\n     <!-- <svg class=\"video-icon\" v-if=\"item.fileType\" aria-hidden=\"true\">\r\n        <use xlink:href=\"#icon-videofill\"></use>\r\n      </svg> -->\r\n      <span v-if=\"item.fileType\" class=\"iconfont video-icon\">&#xe7c7;</span>\r\n      </view>\r\n      <view class=\"hobby-title\" ref=\"hobbyTitle\">{{ item.title }}</view>\r\n      <view class=\"hobby-info\">\r\n        <view class=\"info\">\r\n          <image class=\"avatar\" mode=\"aspectFit\" :src=\"item.avatar\"></image>\r\n        <text>{{ item.username }}</text>\r\n        </view>\r\n        <view>\r\n          <!-- <svg v-if=\"item.likeFlag\" class=\"icon\" aria-hidden=\"true\" @click.stop=\"like(item)\">\r\n            <use xlink:href=\"#icon-xihuan1\"></use>\r\n          </svg>\r\n          <svg v-else class=\"icon\" aria-hidden=\"true\" @click.stop=\"like(item)\">\r\n            <use xlink:href=\"#icon-xihuan\"></use>\r\n          </svg> -->\r\n          <span v-if=\"item.likeFlag\" style=\"color: #f00;\" class=\"iconfont\" @click.stop=\"like(item)\">&#xe86f;</span>\r\n          <span v-else class=\"iconfont\" @click.stop=\"like(item)\">&#xe86f;</span>\r\n          <text style=\"margin-left: 10rpx;\">{{item.likes}}</text>\r\n        </view>\r\n      </view>\r\n    </view>\r\n  </view>\r\n</template>\r\n\r\n<script>\r\nexport default {\r\n  name: \"waterFall\",\r\n};\r\n</script>\r\n\r\n<script setup>\r\nimport {\r\n  ref,\r\n  reactive,\r\n  onMounted,\r\n  onUpdated,\r\n  getCurrentInstance,\r\n  watchEffect,\r\n} from \"vue\";\r\n\r\nimport { getLike, setLike } from \"@/api/communication.js\";\r\n\r\nconst props = defineProps({\r\n  list: {\r\n    type: Array,\r\n    default: [],\r\n  },\r\n  activeIndex: {\r\n    type: Number,\r\n    default: 1,\r\n  }\r\n});\r\nlet waterfallList = ref([]); // 需要渲染的数据列表\r\nlet waterfallImageWidth = ref(328); // 每一列宽度\r\nlet waterfallImageCol = ref(2); // 每行显示几列\r\nlet waterfallImageRight = ref(20); // 右边距\r\nlet waterfallImageBottom = ref(20); // 下边距\r\nlet waterfallDeviationHeight = ref([]); // 存放瀑布流各个列的高度\r\nlet hobbyTitle = ref(null);\r\nlet waterfall = ref(null);\r\nconst initWaterfall = () => {\r\n  waterfallDeviationHeight.value = new Array(waterfallImageCol.value);\r\n  for (let i = 0; i < waterfallDeviationHeight.value.length; i++) {\r\n    waterfallDeviationHeight.value[i] = 0;\r\n  }\r\n  imagePreLoading();\r\n};\r\n\r\n/**\r\n * @description: 图片预加载\r\n * @param {*}\r\n * @Author:\r\n * @return {*}\r\n */\r\nconst imagePreLoading = async () => {\r\n  for (let i = 0; i < props.list.length; i++) {\r\n    let image = new Image();\r\n    image.src = props.list[i].url;\r\n    console.log(\"waterfall==\", waterfall.value);\r\n    const img = await new Promise((resolve) => {\r\n      image.onload = (e) => {\r\n        console.log(\"e=\", e);\r\n        let imageData = {};\r\n        imageData.height =\r\n          (waterfallImageWidth.value / image.width) * image.height + 160;\r\n        imageData.id = props.list[i].id;\r\n        imageData.src = props.list[i].url;\r\n        imageData.title = props.list[i].title;\r\n        imageData.avatar = props.list[i].avatar;\r\n        imageData.username = props.list[i].username;\r\n        imageData.likes = props.list[i].likes;\r\n        imageData.fileType = props.list[i].fileType\r\n        waterfallList.value.push(imageData);\r\n        rankImage(imageData);\r\n        resolve(imageData);\r\n      };\r\n    });\r\n    getLikes()\r\n    console.log(\"img==\", img);\r\n  }\r\n};\r\n\r\nconst rankImage = (imageData) => {\r\n  const min = Math.min.apply(null, waterfallDeviationHeight.value);\r\n  let minIndex = waterfallDeviationHeight.value.indexOf(min);\r\n  imageData.top = waterfallDeviationHeight.value[minIndex];\r\n  imageData.left =\r\n    minIndex * (waterfallImageRight.value + waterfallImageWidth.value);\r\n  waterfallDeviationHeight.value[minIndex] +=\r\n    imageData.height + waterfallImageBottom.value;\r\n  console.log(\"imageData==\", imageData);\r\n};\r\n\r\nconst goDetail = (item) => {\r\n  console.log('item=', item)\r\n  console.log('props===', props)\r\n    uni.navigateTo({\r\n    url: `/pages/index/HobbyDetailMountain?id=${item.id}&hobby=${props.activeIndex}`,\r\n  });\r\n}\r\n\r\n// 点赞\r\nconst like = (item) => {\r\n  console.log('item=', item)\r\n  // item.likeFlag = true\r\n  let likeIds = uni.getStorageSync('like') || []\r\n  if(likeIds.includes(item.id)){\r\n    console.log('isOK=', likeIds)\r\n    for(let i = 0;i < likeIds.length; i++){\r\n      if(likeIds[i] === item.id){\r\n        likeIds.splice(i, 1)\r\n      }\r\n    }\r\n    item.likes -= 1\r\n    item.likeFlag = false\r\n    uni.setStorageSync('like', likeIds)\r\n  } else {\r\n      \r\n  item.likes += 1\r\n  item.likeFlag = true\r\n  console.log('likeIds=', likeIds)\r\n  likeIds.unshift(item.id)\r\n  uni.setStorageSync('like', likeIds)\r\n  }\r\n  const params = { hobby: props.activeIndex, hobbyId: item.id }\r\n  setLike(params).then(data => {\r\n    console.log('like data=', data)\r\n  })\r\n\r\n}\r\n\r\nconst getLikes = () => {\r\n  const params = {\r\n    hobby: props.activeIndex\r\n  }\r\n  getLike(params).then(data => {\r\n    console.log('getLike=', data)\r\n                if (data.data.code === 200) {\r\n          const ids = data.data.likes.map(item => item.hobby_id)\r\n          uni.setStorageSync('like', ids)\r\n          for(let i= 0; i < waterfallList.value.length; i++){\r\n            if(ids.includes(waterfallList.value[i].id)){\r\n              waterfallList.value[i].likeFlag = true\r\n            } else {\r\n              waterfallList.value[i].likeFlag = false\r\n            }\r\n          }\r\n          console.log('waterfallList====', waterfallList.value)\r\n        }\r\n  })\r\n}\r\n\r\nonMounted(() => {\r\n  console.log(\"list1=\", props.list);\r\n  initWaterfall();\r\n});\r\nonUpdated(() => {\r\n  console.log(\"list2=\", props.list);\r\n  // initWaterfall();\r\n});\r\n\r\nwatchEffect(() => {\r\n  initWaterfall();\r\n});\r\n</script>\r\n\r\n<style lang=\"scss\" scoped>\r\n.waterfall {\r\n  width: 100%;\r\n  height: 100%;\r\n  position: relative;\r\n}\r\n.waterfall-item {\r\n  position: absolute;\r\n  float: left;\r\n}\r\n.waterfall-image-wrapper{\r\n  position: relative;\r\n  .waterfall-image{\r\n    position: absolue;\r\n  }\r\n  .video-icon{\r\n    position: absolute;\r\n    left: 50%;\r\n    top: 50%;\r\n    transform: translate(-50%, -50%);\r\n    width: 2em;\r\n    height: 2em;\r\n    vertical-align: -0.15em;\r\n    fill: currentColor;\r\n    overflow: hidden;\r\n    opacity: 0.6;\r\n  }\r\n}\r\n.hobby-title {\r\n  position: relative;\r\n  // bottom: 0;\r\n  padding: 20rpx;\r\n  overflow: hidden;\r\n  text-overflow: ellipsis;\r\n  display: block;\r\n  -webkit-line-clamp: 2;\r\n  -webkit-box-orient: vertical;\r\n  color: #363636;\r\n  background-color: #fff;\r\n}\r\n.hobby-info {\r\n  display: flex;\r\n  background-color: #fff;\r\n  padding:0 20rpx 20rpx;\r\n  justify-content: space-between;\r\n  align-items: center;\r\n  font-size: 24rpx;\r\n  .info{\r\n    display: flex;\r\n    align-items: center;\r\n  }\r\n.avatar {\r\n    width: 52rpx;\r\n    height: 52rpx;\r\n    border-radius: 50%;\r\n    background-color: #ccc;\r\n    margin-right: 20rpx;\r\n  }\r\n}\r\n</style>\r\n","import Component from 'C:/myself/social/social/src/pages/index/WaterFall.vue'\nwx.createComponent(Component)"],"names":["name","waterfallList","ref","waterfallImageWidth","waterfallImageCol","waterfallImageRight","waterfallImageBottom","waterfallDeviationHeight","waterfall","initWaterfall","value","Array","i","length","imagePreLoading","async","props","list","image","Image","src","url","log","img","Promise","resolve","onload","e","imageData","height","width","id","title","avatar","username","likes","fileType","push","rankImage","min","Math","apply","minIndex","indexOf","top","left","like","item","likeIds","uni","getStorageSync","includes","splice","likeFlag","setStorageSync","unshift","params","hobby","activeIndex","hobbyId","then","data","getLikes","code","ids","map","hobby_id","navigateTo","wx","createComponent","Component"],"mappings":"8JAuDA,QAAe,CACbA,KAAM,gIA0BJC,EAAgBC,MAAI,IACpBC,EAAsBD,MAAI,KAC1BE,EAAoBF,MAAI,GACxBG,EAAsBH,MAAI,IAC1BI,EAAuBJ,MAAI,IAC3BK,EAA2BL,MAAI,UACd,UACjBM,EAAYN,MAAI,YACdO,EAAgB,OACKC,MAAQ,IAAIC,MAAMP,EAAkBM,eACpDE,EAAI,EAAGA,EAAIL,EAAyBG,MAAMG,OAAQD,MAChCF,MAAME,GAAK,OAWlCE,EAAkBC,kBACbH,EAAI,EAAGA,EAAII,EAAMC,KAAKJ,OAAQD,IAAK,KACtCM,EAAQ,IAAIC,QACVC,IAAMJ,EAAMC,KAAKL,GAAGS,YAClBC,IAAI,cAAed,EAAUE,aAC/Ba,QAAY,IAAIC,SAASC,MACvBC,OAAUC,YACNL,IAAI,KAAMK,OACdC,EAAY,KACNC,OACP1B,EAAoBO,MAAQQ,EAAMY,MAASZ,EAAMW,OAAS,MACnDE,GAAKf,EAAMC,KAAKL,GAAGmB,KACnBX,IAAMJ,EAAMC,KAAKL,GAAGS,MACpBW,MAAQhB,EAAMC,KAAKL,GAAGoB,QACtBC,OAASjB,EAAMC,KAAKL,GAAGqB,SACvBC,SAAWlB,EAAMC,KAAKL,GAAGsB,WACzBC,MAAQnB,EAAMC,KAAKL,GAAGuB,QACtBC,SAAWpB,EAAMC,KAAKL,GAAGwB,WACrB1B,MAAM2B,KAAKT,KACfA,KACFA,mBAIJN,IAAI,QAASC,KAInBe,EAAaV,UACXW,EAAMC,KAAKD,IAAIE,MAAM,KAAMlC,EAAyBG,WACtDgC,EAAWnC,EAAyBG,MAAMiC,QAAQJ,KAC5CK,IAAMrC,EAAyBG,MAAMgC,KACrCG,KACRH,KAAgChC,MAAQP,EAAoBO,SACrCA,MAAMgC,IAC7Bd,EAAUC,OAASvB,EAAqBI,cAClCY,IAAI,cAAeM,IAYvBkB,EAAQC,YACJzB,IAAI,QAASyB,OAEjBC,EAAUC,QAAIC,eAAe,SAAW,MACzCF,EAAQG,SAASJ,EAAKhB,IAAI,SACnBT,IAAI,QAAS0B,WACbpC,EAAI,EAAEA,EAAIoC,EAAQnC,OAAQD,IAC7BoC,EAAQpC,KAAOmC,EAAKhB,MACbqB,OAAOxC,EAAG,KAGjBuB,OAAS,IACTkB,UAAW,UACZC,eAAe,OAAQN,UAGxBb,OAAS,IACTkB,UAAW,UACR/B,IAAI,WAAY0B,KAChBO,QAAQR,EAAKhB,YACjBuB,eAAe,OAAQN,SAErBQ,EAAS,CAAEC,MAAOzC,EAAM0C,YAAaC,QAASZ,EAAKhB,cACjDyB,GAAQI,kBACNtC,IAAI,aAAcuC,OAKxBC,EAAW,WACTN,EAAS,CACbC,MAAOzC,EAAM0C,uBAEPF,GAAQI,qBACNtC,IAAI,WAAYuC,GACW,MAAnBA,EAAKA,KAAKE,KAAc,OAC5BC,EAAMH,EAAKA,KAAK1B,MAAM8B,QAAYlB,EAAKmB,mBACzCZ,eAAe,OAAQU,WACnBpD,EAAG,EAAGA,EAAIX,EAAcS,MAAMG,OAAQD,IACzCoD,EAAIb,SAASlD,EAAcS,MAAME,GAAGmB,MACvBrB,MAAME,GAAGyC,UAAW,IAEpB3C,MAAME,GAAGyC,UAAW,UAG9B/B,IAAI,oBAAqBrB,EAAcS,gCAK/C,aACAY,IAAI,SAAUN,EAAMC,0BAGpB,aACAK,IAAI,SAAUN,EAAMC,wBAIlB,2QApEK,CAAC8B,YACRzB,IAAI,QAASyB,WACbzB,IAAI,WAAYN,WAClBmD,WAAW,CACf9C,IAAK,uCAAuC0B,EAAKhB,YAAYf,EAAM0C,iHClJvEU,GAAGC,gBAAgBC"}